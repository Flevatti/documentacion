"use strict";(self.webpackChunkdocumentacion=self.webpackChunkdocumentacion||[]).push([[8736],{3905:(e,a,n)=>{n.d(a,{Zo:()=>c,kt:()=>u});var r=n(7294);function t(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function o(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);a&&(r=r.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?o(Object(n),!0).forEach((function(a){t(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function i(e,a){if(null==e)return{};var n,r,t=function(e,a){if(null==e)return{};var n,r,t={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],a.indexOf(n)>=0||(t[n]=e[n]);return t}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(t[n]=e[n])}return t}var l=r.createContext({}),m=function(e){var a=r.useContext(l),n=a;return e&&(n="function"==typeof e?e(a):s(s({},a),e)),n},c=function(e){var a=m(e.components);return r.createElement(l.Provider,{value:a},e.children)},d={inlineCode:"code",wrapper:function(e){var a=e.children;return r.createElement(r.Fragment,{},a)}},p=r.forwardRef((function(e,a){var n=e.components,t=e.mdxType,o=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=m(n),u=t,v=p["".concat(l,".").concat(u)]||p[u]||d[u]||o;return n?r.createElement(v,s(s({ref:a},c),{},{components:n})):r.createElement(v,s({ref:a},c))}));function u(e,a){var n=arguments,t=a&&a.mdxType;if("string"==typeof e||t){var o=n.length,s=new Array(o);s[0]=p;var i={};for(var l in a)hasOwnProperty.call(a,l)&&(i[l]=a[l]);i.originalType=e,i.mdxType="string"==typeof e?e:t,s[1]=i;for(var m=2;m<o;m++)s[m]=n[m];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7503:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>m});var r=n(7462),t=(n(7294),n(3905));const o={sidebar_position:6},s="Guia practica - 2022",i={unversionedId:"Node/Guia",id:"Node/Guia",title:"Guia practica - 2022",description:"Iniciamos el proyecto",source:"@site/docs/Node/Guia.md",sourceDirName:"Node",slug:"/Node/Guia",permalink:"/documentacion/docs/Node/Guia",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Node/Guia.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"Node",previous:{title:"Token y Practica API REST",permalink:"/documentacion/docs/Node/token"},next:{title:"API REST 2022",permalink:"/documentacion/docs/Node/apiRest"}},l={},m=[{value:"carpeta public",id:"carpeta-public",level:2},{value:"Motor de plantilla",id:"motor-de-plantilla",level:2},{value:"Configuracion",id:"configuracion",level:2},{value:"main.hbs",id:"mainhbs",level:2},{value:"CSS , JS , etc",id:"css--js--etc",level:2},{value:"Each",id:"each",level:2},{value:"Configurar Partials",id:"configurar-partials",level:2},{value:"Configuracion",id:"configuracion-1",level:3},{value:"Llamar a un partials",id:"llamar-a-un-partials",level:3},{value:"Router",id:"router",level:2},{value:"Configuracion mongoDB",id:"configuracion-mongodb",level:2},{value:"En el sitio de MongoDB",id:"en-el-sitio-de-mongodb",level:3},{value:"En el proyecto",id:"en-el-proyecto",level:3},{value:"modulos",id:"modulos",level:3},{value:"Establecer conexion",id:"establecer-conexion",level:3},{value:"Volvemos a MongoDB(sitio web)",id:"volvemos-a-mongodbsitio-web",level:3},{value:"Modelo/Esquema",id:"modeloesquema",level:2},{value:"En el proyecto",id:"en-el-proyecto-1",level:3},{value:"Controladores (MVC)",id:"controladores-mvc",level:2},{value:"Instanciar un modelo",id:"instanciar-un-modelo",level:2},{value:"Guardar en la BD",id:"guardar-en-la-bd",level:2},{value:"Ahora vamos a hacer que se guarde en la BD, la informaci\xf3n que se env\xeda en el formulario:",id:"ahora-vamos-a-hacer-que-se-guarde-en-la-bd-la-informaci\xf3n-que-se-env\xeda-en-el-formulario",level:3},{value:"Eliminar datos",id:"eliminar-datos",level:2},{value:"Validacion con middlewares",id:"validacion-con-middlewares",level:2},{value:"Editar en MongoDB",id:"editar-en-mongodb",level:2},{value:"clipboard",id:"clipboard",level:2},{value:"Redireccionamiento",id:"redireccionamiento",level:2},{value:"Registrar usuario",id:"registrar-usuario",level:2},{value:"Respuestas",id:"respuestas",level:2},{value:"Modelo Usuario",id:"modelo-usuario",level:2},{value:"Cifrar la contrase\xf1a",id:"cifrar-la-contrase\xf1a",level:2},{value:"Creamos un hash",id:"creamos-un-hash",level:3},{value:"Tutorial de bycriptjs",id:"tutorial-de-bycriptjs",level:3},{value:"pre mongosee",id:"pre-mongosee",level:2},{value:"ConfirmarCuenta",id:"confirmarcuenta",level:2},{value:"Iniciar sesion",id:"iniciar-sesion",level:2},{value:"A\xf1adirle metodos al esquema mongoDB",id:"a\xf1adirle-metodos-al-esquema-mongodb",level:2},{value:"Favicon",id:"favicon",level:2},{value:"Session",id:"session",level:2},{value:"Ejemplo",id:"ejemplo",level:3},{value:"Flash",id:"flash",level:2},{value:"Ejemplo",id:"ejemplo-1",level:3},{value:"Validaciones(Express-validator)",id:"validacionesexpress-validator",level:2},{value:"Validamos el login tambi\xe9n:",id:"validamos-el-login-tambi\xe9n",level:3},{value:"Validaciones en la vista",id:"validaciones-en-la-vista",level:2},{value:"Passport",id:"passport",level:2},{value:"req.login()",id:"reqlogin",level:3},{value:"serializerUser()",id:"serializeruser",level:3},{value:"deserializerUser()",id:"deserializeruser",level:3},{value:"logout()",id:"logout",level:3},{value:"En el proyecto",id:"en-el-proyecto-2",level:3},{value:"Middleware para verificar sesion",id:"middleware-para-verificar-sesion",level:2},{value:"Cerrar sesion",id:"cerrar-sesion",level:2},{value:"CSRF protection middleware",id:"csrf-protection-middleware",level:2},{value:"Ahora vamos a mandarle ese dato a la vista cuando renderizamos",id:"ahora-vamos-a-mandarle-ese-dato-a-la-vista-cuando-renderizamos",level:3},{value:"De forma manual:",id:"de-forma-manual",level:4},{value:"De forma global a trav\xe9s de un middleware",id:"de-forma-global-a-trav\xe9s-de-un-middleware",level:4},{value:"Variables globales",id:"variables-globales",level:2},{value:"Cambios en el proyecto",id:"cambios-en-el-proyecto",level:2},{value:"Verificamos la sesion en las rutas de home",id:"verificamos-la-sesion-en-las-rutas-de-home",level:3},{value:"Ponemos mensajes flash que se puedan ver en la vista sobre las validaciones de la url",id:"ponemos-mensajes-flash-que-se-puedan-ver-en-la-vista-sobre-las-validaciones-de-la-url",level:3},{value:"ref mongoDB",id:"ref-mongodb",level:2},{value:"Nodemailer",id:"nodemailer",level:2},{value:"Guia de mailtrap",id:"guia-de-mailtrap",level:3},{value:"Guia  de NodeMailer",id:"guia--de-nodemailer",level:3},{value:"En el proyecto",id:"en-el-proyecto-3",level:3},{value:"Subir archivos",id:"subir-archivos",level:2},{value:"Formidable",id:"formidable",level:2},{value:"Peque\xf1o tutorial",id:"peque\xf1o-tutorial",level:3},{value:"Modulo nativo Path (Join)",id:"modulo-nativo-path-join",level:2},{value:"file System",id:"file-system",level:2},{value:"A guardar en la BD la url de la imagen",id:"a-guardar-en-la-bd-la-url-de-la-imagen",level:3},{value:"jimp",id:"jimp",level:2},{value:"connet-mongo",id:"connet-mongo",level:2},{value:"Configuramos las sesiones para que se respalden en la BD.",id:"configuramos-las-sesiones-para-que-se-respalden-en-la-bd",level:3},{value:"Saniteze mongo",id:"saniteze-mongo",level:2},{value:"CORS",id:"cors",level:2},{value:"Modificaciones para el deploy",id:"modificaciones-para-el-deploy",level:2},{value:"Cookies segura",id:"cookies-segura",level:2},{value:"Heroku",id:"heroku",level:2},{value:"En el sitio",id:"en-el-sitio-1",level:3},{value:"Consejos",id:"consejos",level:2}],c={toc:m};function d(e){let{components:a,...n}=e;return(0,t.kt)("wrapper",(0,r.Z)({},c,n,{components:a,mdxType:"MDXLayout"}),(0,t.kt)("h1",{id:"guia-practica---2022"},"Guia practica - 2022"),(0,t.kt)("p",null," Iniciamos el proyecto "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm init -y\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"}," No utilizar espacios , tildes y no colocar nombres reservados (nombre de  package/modulos)"))),(0,t.kt)("p",null," package.json:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-json"},'{\n "name": "practica",\n "version": "1.0.0",\n "description": "",\n "main": "index.js",\n "scripts": {\n   "dev": "nodemon index.js",\n   "start": "node index.js"\n },\n "keywords": [],\n "author": "",\n "license": "ISC",\n "devDependencies": {\n   "nodemon": "^2.0.15"\n },\n "dependencies": {\n   "express": "^4.17.3"\n }\n}\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"modelo MVC")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Vamos a trabajar con el modelo vista controlador"),(0,t.kt)("p",{parentName:"div"},"Los controladores , las vistas y los modelos los vamos a separar"))),(0,t.kt)("h2",{id:"carpeta-public"},"carpeta public"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Cuando se trabaja desde el backend todo esta protegido , no se puede acceder desde el navegador.")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Pero podemos crear la carpeta public cuyos archivos si son p\xfablicos, se pueden acceder desde el navegador (ingresando la url)"))),(0,t.kt)("p",null,"Creamos la carpeta public y dentro un archivo index.html "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-html"},'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Document</title>\n</head>\n<body>\n    <h1>index.html</h1>\n</body>\n</html>\n\n')),(0,t.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"TODAVIA NO SE PUEDE ACCEDER A index.html desde el navegador porque no esta configurada la carpeta public."),(0,t.kt)("p",{parentName:"div"},"Para hacer que todos los archivos de la carpeta public puedan ser accedido desde el navegador usamos el middleware."))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"middleware")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Middleware = Se ejecuta antes de la respuesta del servidor."),(0,t.kt)("li",{parentName:"ul"},"use = Middleware.")))),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const express = require("express");\nconst app = express();\n// Usamos el middleware de express\n// Asignamos la carpeta publica\napp.use(express.static(__dirname + "/public"));\n// req = requirimiento(lo que manda el usuario) res = respuesta\napp.get("/", (req, res) => {\n    res.send("estas solicitando la ruta raiz");\n});\n\nconst PORT = process.env.PORT || 5000;\napp.listen(PORT, () => console.log("server andando \ud83d\udd25 http://localhost:5000"));\n\n')),(0,t.kt)("h2",{id:"motor-de-plantilla"},"Motor de plantilla"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Para no repetir todo el c\xf3digo HTML (por ejemplo, todos los archivos HTML deben tener el mismo footer o el mismo men\xfa) , surgieron los motores de plantilla.")),(0,t.kt)("p",null,"Instalamos un motor de plantilla  (existen muchos)"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i express express-handlebars\n")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Se parece a vue pero es mucho mas viejo."),(0,t.kt)("li",{parentName:"ul"},"Tiene limitantes este motor de plantilla, que soluciona react , vue , etc.")),(0,t.kt)("p",null,"Creamos una carpeta views y dentro  la carpeta layouts."),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"views ",(0,t.kt)("ul",{parentName:"li"},(0,t.kt)("li",{parentName:"ul"},"layouts")))),(0,t.kt)("p",null,"Lo archivos que contiene layouts son los que podemos repetir en todas las p\xe1ginas web (men\xfa, footer , etc)."),(0,t.kt)("p",null,"dentro de la carpeta layouts creamos un archivo main.hbs"),(0,t.kt)("p",null,"views/layouts/main.hbs:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Desde HBS</title>\n</head>\n<body>\n    <h1>Plantilla</h1>\n</body>\n</html>\n\n')),(0,t.kt)("p",null,"y creamos el archivo home.hbs en la carpeta views"),(0,t.kt)("p",null,"views/home.hbs:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Document</title>\n</head>\n<body>\n    <h1>Hola desde Home</h1>\n</body>\n</html>\n\n')),(0,t.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Nodemon no actualiza el servidor si hay alg\xfan cambio dentro de alg\xfan archivo hbs."),(0,t.kt)("p",{parentName:"div"},"Para solucionar esto creamos en la ruta raiz el archivo nodemon.json que va a contener:"),(0,t.kt)("pre",{parentName:"div"},(0,t.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "ext": "js,json,hbs"\n}\n\n')),(0,t.kt)("p",{parentName:"div"},"En pocas palabras , estamos configurando Nodemon para que detecte cambios en archivos .js , .json y .hbs."))),(0,t.kt)("h2",{id:"configuracion"},"Configuracion"),(0,t.kt)("p",null,"Ahora vamos a configurar el motor de plantilla en el archivo index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'\nconst express = require("express");\n// const create = recibe las configuraciones de express-handlebards\nconst { create } = require("express-handlebars");\n// Le decimos que la extension de los archivos de views es  .hbs\nconst hbs = create({\n    extname: ".hbs",\n});\nconst app = express();\n// Configuramos express \n// Le decimos que motor de plantilla usar\n// Especificamos el motor de plantilla\napp.engine(".hbs", hbs.engine);\n// Especificamos la extension del motor del plantilla (.hbs)\napp.set("view engine", ".hbs");\n// Especificamos la carpeta en donde van a estar los archivos .hbs\napp.set("views", "./views");\n\n\napp.use(express.static(__dirname + "/public"));\napp.get("/", (req, res) => {\n    // Como respuesta renderiza(convierte en HTML) el archivo home.hbs\n    // Se puede quitar el .hbs\n    res.render(\'home\')\n});\n\nconst PORT = process.env.PORT || 5000;\napp.listen(PORT, () => console.log("server andando \ud83d\udd25 http://localhost:5000"));\n\n')),(0,t.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Como la carpeta public la maneja el middleware y este se ejecuta antes de que el servidor reciba las peticiones get/post/etc , lo que contiene la carpeta public se llama primero."),(0,t.kt)("li",{parentName:"ul"},'La l\xednea app.use(express.static(__dirname + "/public")); debe ir debajo de todo para evitar conflictos entre las rutas y archivos publicos')),(0,t.kt)("pre",{parentName:"div"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},'\n\nconst express = require("express");\n// const create = recibe las configuraciones de express-handlebards\nconst { create } = require("express-handlebars");\n// Le decimos que la extension de los archivos de views es  .hbs\nconst hbs = create({\n    extname: ".hbs",\n});\nconst app = express();\n// Configuramos express \n// Le decimos que motor de plantilla usar\n// Especificamos el motor de plantilla\napp.engine(".hbs", hbs.engine);\n// Especificamos la extension del motor del plantilla (.hbs)\napp.set("view engine", ".hbs");\n// Especificamos la carpeta en donde van a estar los archivos .hbs\napp.set("views", "./views");\n\n\n\napp.get("/", (req, res) => {\n    // Como respuesta renderiza(convierte en HTML) el archivo home.hbs\n    // Se puede quitar el .hbs\n    res.render(\'home\')\n});\napp.use(express.static(__dirname + "/public"));\nconst PORT = process.env.PORT || 5000;\napp.listen(PORT, () => console.log("server andando \ud83d\udd25 http://localhost:5000"));\n\n')))),(0,t.kt)("h2",{id:"mainhbs"},"main.hbs"),(0,t.kt)("p",null,"Como se ve, se muestra la plantilla (el archivo main.hbs) y no el home.hbs."),(0,t.kt)("p",null,"Esto es porque , Se lee de forma autom\xe1tica el main.hbs"),(0,t.kt)("p",null,"La plantilla main.hbs se utiliza en todas las paginas"),(0,t.kt)("p",null,"Por lo tanto podemos hacer que lo que est\xe1 en el home.hbs  aparezca adentro del body del main.hbs"),(0,t.kt)("p",null,"home.hbs:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"}," <h1>Hola desde Home</h1>\n")),(0,t.kt)("p",null,"main.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Desde HBS</title>\n</head>\n<body>\n      {{{body}}}\n</body>\n</html>\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"variable body ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Usamos la variable body  que tiene hbs , que su valor es todo lo que contiene  home.hbs"))),(0,t.kt)("p",null,"Creamos un archivo login.hbs en views\nviews/login.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},"<h1>Login</h1>\n")),(0,t.kt)("p",null,"index.js:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'\nconst express = require("express");\n// const create = recibe las configuraciones de express-handlebards\nconst { create } = require("express-handlebars");\n// Le decimos que la extension de los archivos de views es  .hbs\nconst hbs = create({\n    extname: ".hbs",\n});\nconst app = express();\n// Configuramos express \n// Le decimos que motor de plantilla usar\n// Especificamos el motor de plantilla\napp.engine(".hbs", hbs.engine);\n// Especificamos la extension del motor del plantilla (.hbs)\napp.set("view engine", ".hbs");\n// Especificamos la carpeta en donde van a estar los archivos .hbs\napp.set("views", "./views");\n\n\n\napp.get("/", (req, res) => {\n    // Como respuesta renderiza(convierte en HTML) el archivo home.hbs\n    // Se puede quitar el .hbs\n    res.render(\'home\')\n});\napp.get("/login", (req, res) => {\n    // Como respuesta renderiza(convierte en HTML) el archivo home.hbs\n    // Se puede quitar el .hbs\n    res.render(\'login\')\n});\napp.use(express.static(__dirname + "/public"));\nconst PORT = process.env.PORT || 5000;\napp.listen(PORT, () => console.log("server andando \ud83d\udd25 http://localhost:5000"));\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"variable body ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Al entrar a http://localhost:5000/login la variable body de main.hbs contiene  todo el contenido de login.hbs"))),(0,t.kt)("h2",{id:"css--js--etc"},"CSS , JS , etc"),(0,t.kt)("p",null,"A\xf1adimos boostrap a las dos rutas"),(0,t.kt)("p",null,"main.hbs:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Desde HBS</title>\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">\n</head>\n<body>\n    <div class="container mt-5">\n {{{body}}}\n    </div>\n     \n      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"><\/script>\n</body>\n</html>\n\n')),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Todas las paginas que tengamos, van a tener Bootstrap"),(0,t.kt)("li",{parentName:"ul"},"Y todo el contenido de XXX.hbs va a estar en un div que contiene clases de Bootstrap")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"carpeta public ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"carpeta public = trabajar con el frontend = se muestra en el navegador"),(0,t.kt)("li",{parentName:"ul"},"el resto de carpetas(incluida la raiz) = trabajar con el backend")))),(0,t.kt)("p",null,"Invocar un script que esta en la carpeta public:"),(0,t.kt)("p",null,"public/js/script.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'console.log("Hola");\n\n')),(0,t.kt)("p",null,"main.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Desde HBS</title>\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">\n</head>\n<body>\n    <div class="container mt-5">\n {{{body}}}\n    </div>\n     \n      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"><\/script>\n      <script src="/js/script.js"><\/script>\n</body>\n\n')),(0,t.kt)("h2",{id:"each"},"Each"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Vamos a usar los Block Helpers"),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",{parentName:"li",href:"https://handlebarsjs.com/guide/block-helpers.html#simple-iterators"},"Link")),(0,t.kt)("li",{parentName:"ul"},"Each  == forEach ")),(0,t.kt)("p",null,"home.hbs: "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<h1>Hola desde Home</h1>\n    {{#each urls }}\n          <article class="card mb-2">\n        <div class="card-body">\n            <p>{{this.origen}}</p>\n            <p>{{this.shortUrl}}</p>\n            <a href="#" class="btn btn-danger">Eliminar</a>\n            <a href="#" class="btn btn-warning">Editar</a>\n            <a href="#" class="btn btn-info">copiar</a>\n        </div>\n    </article>\n    {{/each}}\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"carpeta Components")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Vamos a crear la carpeta components dentro de views que son pedazitos de c\xf3digo que se van a repetir (el c\xf3digo se suele repetir por medio de ciclos (each, etc))"))),(0,t.kt)("p",null,"Y dentro de la carpeta creamos el archivo Card.hbs"),(0,t.kt)("p",null,"views/components/Card.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<article class="card mb-2">\n        <div class="card-body">\n            <p>{{this.origen}}</p>\n            <p>{{this.shortUrl}}</p>\n            <a href="#" class="btn btn-danger">Eliminar</a>\n            <a href="#" class="btn btn-warning">Editar</a>\n            <a href="#" class="btn btn-info">copiar</a>\n        </div>\n    </article>\n\n')),(0,t.kt)("h2",{id:"configurar-partials"},"Configurar Partials"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"partials = sirve para  separar trozos de hbs que se van a repetir. (ciclos (each) , menu , footer , etc)"),(0,t.kt)("li",{parentName:"ul"},"en el partials puede ir  footer.hbs , navbar.hbs , etc.")),(0,t.kt)("h3",{id:"configuracion-1"},"Configuracion"),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'// Le decimos que la extension de los archivos de views es  .hbs y que los partials se encuentran en views/components\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\n\n')),(0,t.kt)("h3",{id:"llamar-a-un-partials"},"Llamar a un partials"),(0,t.kt)("p",null,"Para llamar a un partial dentro de una plantilla"),(0,t.kt)("p",null,"home.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},"    <h1>Hola desde Home</h1>\n    {{#each urls }}\n         {{> Card   url=this}}\n    {{/each}}\n  \n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Explicacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"por cada iteraci\xf3n , invoca al Card.hbs  pasando como url cada componente del array urls"))),(0,t.kt)("p",null,"Otra manera:\nhome.hbs:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},"   <h1>Hola desde Home</h1>\n    {{#each urls }}\n         {{> Card   item=this}}\n    {{/each}}\n  \n\n")),(0,t.kt)("p",null,"Card.hbs "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},' <article class="card mb-2">\n        <div class="card-body">\n            <p>{{item.origen}}</p>\n            <p>{{item.shortUrl}}</p>\n            <a href="#" class="btn btn-danger">Eliminar</a>\n            <a href="#" class="btn btn-warning">Editar</a>\n            <a href="#" class="btn btn-info">copiar</a>\n        </div>\n    </article>\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Le pod\xe9s quitar los datos opcionales (item=this o url=this) porque los datos del item del array se pasan solo al componente."),(0,t.kt)("li",{parentName:"ul"},"A un componente nosotros le podemos mandar informaci\xf3n , esto se llama props en react y vue.")))),(0,t.kt)("p",null,"Creamos un men\xfa que lo va a utilizar todo el sitio web"),(0,t.kt)("p",null,"views/components/Navbar.hbs"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Convenciones")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Los nombre de los componentes arrancan con Mayuscula."))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<nav class="navbar navbar-expand-lg navbar-dark bg-primary">\n  <div class="container">\n    <a class="navbar-brand" href="/">Navbar</a>\n    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">\n      <span class="navbar-toggler-icon"></span>\n    </button>\n    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">\n      <div class="navbar-nav ms-auto">\n        <a class="nav-link active" aria-current="page" href="/">Home</a>\n        <a class="nav-link" href="/logup">LogUp</a>\n        <a class="nav-link" href="/login">LogIn</a>\n        <a class="nav-link" href="/logout">LogOut</a>\n      </div>\n    </div>\n  </div>\n</nav>\n\n')),(0,t.kt)("p",null,"main.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Desde HBS</title>\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">\n</head>\n<body>\n    {{> Navbar}}\n    <div class="container mt-5">\n {{{body}}}\n    </div>\n     \n      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"><\/script>\n      <script src="/js/script.js"><\/script>\n</body>\n</html>\n\n')),(0,t.kt)("h2",{id:"router"},"Router"),(0,t.kt)("p",null,"Creamos la carpeta llamada routes"),(0,t.kt)("p",null,"Y dentro el archivo home.js"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"routes ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Usamos el Router para crear manejadores de rutas modulares (permite trabajar en m\xf3dulos )"),(0,t.kt)("li",{parentName:"ul"},"Sirve para poner la l\xf3gica de una o varias rutas en un archivo y poder separarlos (m\xf3dulos), de forma que cada archivo es una ruta o un conjunto de rutas relacionadas."),(0,t.kt)("li",{parentName:"ul"},"Lo recomendable es que cada archivo contenga la l\xf3gica de una  ruta para poder trabajar con m\xf3dulos.")))),(0,t.kt)("p",null,"routes/home.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const express = require(\'express\');\nconst router = express.Router();\n\nrouter.get("/" , (req,res) => {\nconst urls = [{origen: "www.google.com" , shortUrl: "hfgdohdf"},{origen: "www.google.com" , shortUrl: "hfgdohdf"},{origen: "www.google.com" , shortUrl: "hfgdohdf"}]\nres.render(\'home\' , {urls })\n})\nmodule.exports = router;\n\n')),(0,t.kt)("p",null,"Tambien creamos el archivo auth.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const express = require('express');\nconst router = express.Router();\nrouter.get(\"/login\", (req, res) => {\n  \n    res.render('login')\n});\n\nmodule.exports = router;\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Como se puede ver cada archivo es una ruta (home = al apartado home  y auth.js = al apartado login)"))),(0,t.kt)("p",null,"en el index.js"),(0,t.kt)("p",null,"Se utiliza el  middleware para usar el router"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const express = require("express");\n\nconst { create } = require("express-handlebars");\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\nconst app = express();\napp.engine(".hbs", hbs.engine);\napp.set("view engine", ".hbs");\napp.set("views", "./views");\n\n\n\n\napp.use(express.static(__dirname + "/public"));\n// Usamos el middleware para utilizar los routes\napp.use("/" , require(\'./routes/home\'));\napp.use("/auth" , require(\'./routes/auth\'));\nconst PORT = process.env.PORT || 5000;\napp.listen(PORT, () => console.log("server andando \ud83d\udd25 http://localhost:5000"));\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Resultado del middleware")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Home =  http://localhost:5000   (No se utilizo ninguno prefijo (/))"),(0,t.kt)("li",{parentName:"ul"},"Login =  http://localhost:5000/auth/login (Ya que se a\xf1adio el prefijo /auth)")))),(0,t.kt)("p",null,"Cambiamos las rutas en el navbar.hbs "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},' <a class="nav-link" href="/logup">LogUp</a>\n        <a class="nav-link" href="/auth/login">LogIn</a>\n        <a class="nav-link" href="/logout">LogOut</a>\n\n')),(0,t.kt)("h2",{id:"configuracion-mongodb"},"Configuracion mongoDB"),(0,t.kt)("h3",{id:"en-el-sitio-de-mongodb"},"En el sitio de MongoDB"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"Creamos un Cluster")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Database \u2013 Build a Database \u2013 Shared \u2013 Free"),(0,t.kt)("li",{parentName:"ul"},"Todas las configuraciones dejarla por defecto."),(0,t.kt)("li",{parentName:"ul"},"Por ultimo le das a Create Cluster")),(0,t.kt)("ol",{start:2},(0,t.kt)("li",{parentName:"ol"},"En network access especificamos las IP de donde nos queremos conectar ",(0,t.kt)("div",{parentName:"li",className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"}," Puede ser:"))))),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"nuestra IP (para mayor seguridad)"),(0,t.kt)("li",{parentName:"ul"},"Permitir que se pueda conectar desde cualquier ip(0.0.0.0)"),(0,t.kt)("li",{parentName:"ul"},"Un conjunto de IP (la nuestra y la de un servidor/hosting)")),(0,t.kt)("ol",{start:3},(0,t.kt)("li",{parentName:"ol"},"En DataBase Access Creamos un usuario",(0,t.kt)("div",{parentName:"li",className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Ejemplo")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"User: User_API\npassword: contrase\xf1a"))))),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Built-in Role para  configurar  el Rol (Accesos)")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"VERSION GRATIS")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"En el modo gratuito solo podemos tener un cluster"),(0,t.kt)("li",{parentName:"ul"},"Un cluster es como un servidor y puede tener varias BD"),(0,t.kt)("li",{parentName:"ul"},"En un cluster podemos tener muchas colecciones.")))),(0,t.kt)("ol",{start:4},(0,t.kt)("li",{parentName:"ol"},"Database \u2013 Connect \u2013 Connect your app -- Drivers")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Copiamos el uri (puede variar)")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"mongodb+srv://<username>:<password>@cluster.xcibc.mongodb.net/myFirstDatabase?retryWrites=true&w=majority\n\n/*\n- Borramos <Username> y ponemos  el usuario por el cual nos conectamos\n- Borramos <password> y ponemos la contrase\xf1a del usuario\n- Borramos miFirstDateBase y ponemos el nombre de la BD a conectarse\n*/\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Ejemplo")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("pre",{parentName:"div"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},"URI:mongodb+srv://User_API:contrase\xf1a@cluster.xcibc.mongodb.net/dbUrl?retryWrites=true&w=majority\n")))),(0,t.kt)("h3",{id:"en-el-proyecto"},"En el proyecto"),(0,t.kt)("p",null,"Creamos el archivo .gitignore"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-gitignore"},"node_modules\n.env\n")),(0,t.kt)("p",null,"Creamos el archivo .env"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),".env ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"En dicho archivo creamos variables protegidas que no se pueden subir a la nube  (github)"),(0,t.kt)("li",{parentName:"ul"},"Sirven para no exponer informacion privada"),(0,t.kt)("li",{parentName:"ul"},"Son variables de entorno"),(0,t.kt)("li",{parentName:"ul"},"Sintaxis: nombrevariable=valor")))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"URI=mongodb+srv://User_API:contrase\xf1a@cluster.xcibc.mongodb.net/dbUrl?retryWrites=true&w=majority\n")),(0,t.kt)("p",null,"Reiniciamos Nodemon ya que no lee el archivo."),(0,t.kt)("h3",{id:"modulos"},"modulos"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Para manejar  MongoDb dentro de node.js usaremos mongosee "),(0,t.kt)("li",{parentName:"ul"},"el \u2013save es para versiones antiguas de npm")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm install mongoose\n")),(0,t.kt)("p",null,"Y para manejar las variables de entorno usaremos dotenv"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i dotenv\n")),(0,t.kt)("h3",{id:"establecer-conexion"},"Establecer conexion"),(0,t.kt)("p",null,"Creamos la carpeta datebase"),(0,t.kt)("p",null,"Y dentro el archivo conexi\xf3n.js(Realizaremos la conexi\xf3n en dicho archivo)"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const mongoose = require(\'mongoose\');\n// Para conectarnos a la BD\n//connect (uri con los datos remplazados)\n// Accedemos al valor de la variable URI de .env\n// Sintaxis: process.env.NOMBREVARIABLE\n\nmongoose.connect(process.env.URI).then(()=> {\n    // Como devuelve una promesa , usamos el then\n    console.log("\'db conectada \ud83d\udd25");\n}).catch(e => console.log("Fallo la conexion" + e));\n\n')),(0,t.kt)("p",null,"Lo llamamos en el index.js:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const express = require("express");\nconst { create } = require("express-handlebars");\n // Para leer las variables de entorno (para acceder a las variables de .env)\n // config(configuraciones) -- Las configuraciones pueden ser desde cambiar el nombre del archivo .env a otras opciones\n require(\'dotenv\').config()\n  // Ejecutamos el archivo database/conexion.js\n  require(\'./database/conexion\');\n\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\n\n')),(0,t.kt)("h3",{id:"volvemos-a-mongodbsitio-web"},"Volvemos a MongoDB(sitio web)"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Database \u2013 Cluster -- Browse Collections"),(0,t.kt)("li",{parentName:"ul"},"Te va a mostrar todas las BD."),(0,t.kt)("li",{parentName:"ul"},"Si le das a Create Database , Creas una colecci\xf3n que va a pertenecer a una BD.")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Explicacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Una colecci\xf3n tiene m\xfaltiples documentos. Lo podes insertar con la opcion insert document  (El documento funciona igual que un objeto de JS propiedad:valor)"),(0,t.kt)("li",{parentName:"ul"},"El documento es un objeto de JS (con multiples metodos)"),(0,t.kt)("li",{parentName:"ul"},"Una BD puede tener m\xfaltiples colleciones.")))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Explicacion como si fuera relacional ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Collecion = tabla"),(0,t.kt)("li",{parentName:"ul"},"Documento = Fila de la tabla"),(0,t.kt)("li",{parentName:"ul"},"Y cada propiedad del documento es una columna.")))),(0,t.kt)("h2",{id:"modeloesquema"},"Modelo/Esquema"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Las colecciones van a tener documentos "),(0,t.kt)("li",{parentName:"ul"},"Y esos documentos est\xe1n compuesto de varias propiedades con sus valores correspondiente.")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Modelo")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"En un modelo definimos el nombre de la colecci\xf3n y las propiedades(columnas) que van a tener sus documentos(filas)"),(0,t.kt)("li",{parentName:"ul"},"A traves del modelo tenemos acceso a m\xe9todos  para crear/modificar/leer/etc documentos.")))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Esquema ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"}," Con Mongoose, todo se deriva de un esquema"),(0,t.kt)("li",{parentName:"ul"},"Cada esquema se asigna a una colecci\xf3n MongoDB y define la forma de los documentos dentro de esa colecci\xf3n."),(0,t.kt)("li",{parentName:"ul"},"El esquema define la estructura de los documentos.")))),(0,t.kt)("h3",{id:"en-el-proyecto-1"},"En el proyecto"),(0,t.kt)("p",null,"Creamos la carpeta models"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"En dicha carpeta vamos a crear los modelos"),(0,t.kt)("li",{parentName:"ul"},"cremos el archivo Url.js en la carpeta ")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"ID ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"La ID se genera de manera autom\xe1tica , por eso no la especificamos."))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Generar String aleatorios")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Vamos a usar ",(0,t.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/nanoid"},"nanoid")," para crear ids aleatorios "),(0,t.kt)("li",{parentName:"ul"},"npm i nanoid")))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Explicacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Para tener acceso a los m\xe9todos  para crear/modificar/leer/etc documentos , debemos crear un esquema y llevarlo a  un modelo."),(0,t.kt)("li",{parentName:"ul"},"Se exporta el modelo no el esquema"),(0,t.kt)("li",{parentName:"ul"},"el esquema sirve para crear el modelo"),(0,t.kt)("li",{parentName:"ul"},"esquema = estructura del documento"),(0,t.kt)("li",{parentName:"ul"},"modelo = creado a partir del esquema , permite tener acceso a los m\xe9todos para el CRUD.")))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Al crearse un objeto de tipo  modelo(el que se crea), se crea la colecci\xf3n y la BD (si no existe)"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const mongoose = require('mongoose')\n// Obtenemos la clase Schema de mongosee\nconst {Schema} = mongoose\nconst {nanoid} = require('nanoid');\n// Esquema\n// Nueva instancia(objeto) de Schema\n// El schema recibe un objeto con las propiedades que va a tener cada documento  y sus restricciones.\nconst urlSchema = new Schema({\n\n    origin: {\n        // La propiedad origen es de tipo String  , es unico , y es obligatorio\n        type: String,\n        unique: true,\n        required: true\n    },\n    shortURL: {\n      // La propiedad shortURL  es de tipo String , es unico , y es obligatorio.\n        type: String,\n        unique: true,\n        required: true,\n        // Por defecto su valor es un String aleatorio (supuestamente unico)\n        //nanoid(numero(representa el largo del string)) genera un string aleatorio\n        default: nanoid(6)\n    }\n})\n//Modelo\n// Singular y comienza en Mayuscula -- variable\n// models (nombre de la coleccion , esquema)\n// Si la coleccion no existe , se crea tanto la BD como la coleccion(en plural)\nconst Url = mongoose.model('Url', urlSchema)\nmodule.exports = Url;\n\n")),(0,t.kt)("h2",{id:"controladores-mvc"},"Controladores (MVC)"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Para trabajar  con el modelo vista \u2013 controlador"),(0,t.kt)("li",{parentName:"ul"},"creamos la carpeta controllers y  dentro el archivo homeController.js"),(0,t.kt)("li",{parentName:"ul"},"En dicho archivo vamos a tener toda la l\xf3gica de leer, actualizar, agregar, etc de la ruta Home"),(0,t.kt)("li",{parentName:"ul"},"En el modelo vista \u2013 controlador, la l\xf3gica debe separarse.")),(0,t.kt)("p",null,"controllers/homeController.js:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const leerUrls = async(req,res) => {\n    const urls = [{origen: "www.google.com" , shortUrl: "hfgdohdf"},{origen: "www.google.com" , shortUrl: "hfgdohdf"},{origen: "www.google.com" , shortUrl: "hfgdohdf"}]\n    res.render(\'home\' , {urls })\n    }\n\n   module.exports = {leerUrls};\n\n')),(0,t.kt)("p",null,"routes/home.js:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"\nconst express = require('express');\nconst router = express.Router();\nconst {leerUrls} = require('../controllers/homeController')\nrouter.get(\"/\" , leerUrls)\nmodule.exports = router;\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"MVC")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Modelo vista controlador"),(0,t.kt)("li",{parentName:"ul"},"controladores \u2013 modelo \u2013 vistas -routes \u2013 database")))),(0,t.kt)("p",null,"Hacemos el agregarUrl"),(0,t.kt)("p",null,"homeController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const agregarUrl = async(req,res) => {}\n   module.exports = {leerUrls , agregarUrl};\n\n")),(0,t.kt)("p",null,"routes/home.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'router.post("/" , agregarUrl)\nmodule.exports = router;\n')),(0,t.kt)("h2",{id:"instanciar-un-modelo"},"Instanciar un modelo"),(0,t.kt)("p",null,"Creamos un componente llamado Form.hbs"),(0,t.kt)("p",null,"components/Form.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<form action="/" method="post">\n<input type="text" placeholder="Ingrese URL" name="origin" class="form-control my-2">\n <button type="submit" class="btn btn-primary w-100 mb-2">Agregar Url</button>\n</form>\n\n')),(0,t.kt)("p",null,"views/home.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},"  <h1>Agrege sus URL</h1>\n    {{> Form}}\n    {{#each urls }}\n         {{> Card   item=this}}\n    {{/each}}\n\n")),(0,t.kt)("p",null,"homeController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// Importamos el modelo\nconst Url = require('../models/Url');\n\nconst agregarUrl = async(req,res) => {\n    try {\n        // Creamos una instancia(objeto) del modelo\n        // new Modelo({propiedades del esquema})\n        //shortUrl tiene un valor por defecto , no hace falta mandarlo\n       const url = new Url({origin:'estatico' })\n        console.log(url);\n        res.send(url);\n    } catch(error) {\n        console.log(error)\n        res.send(\"error algo fallo\");\n    }\n}\n   module.exports = {leerUrls , agregarUrl};\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Explicacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Al momento de instanciar un Modelo, se crea la BD y la colecci\xf3n."),(0,t.kt)("li",{parentName:"ul"},"La instancia es un objeto (documento mongoDB) con todas las propiedades del esquema.")))),(0,t.kt)("h2",{id:"guardar-en-la-bd"},"Guardar en la BD"),(0,t.kt)("p",null,"  modificamos el archivo homeController.js para que al documento mongoDB creado (instancia) se guarde en la BD."),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const agregarUrl = async(req,res) => {\n   try {\n       // Creamos una instancia(objeto) del modelo\n       // new Modelo({propiedades del esquema})\n       //shortUrl tiene un valor por defecto , no hace falta mandarlo\n      // La ID se crea por defecto , no hace falta mandarlo\n      const url = new Url({origin:'estatico' })\n      // Lo guardamos en la BD // Insertamos un documento(fila) en la colecci\xf3n(tabla)\n      await url.save();\n      // Direcciono a la pagina raiz\n      res.redirect('/');\n   } catch(error) {\n       console.log(error)\n       res.send(\"error algo fallo\");\n   }\n}\n  module.exports = {leerUrls , agregarUrl};\n\n")),(0,t.kt)("h3",{id:"ahora-vamos-a-hacer-que-se-guarde-en-la-bd-la-informaci\xf3n-que-se-env\xeda-en-el-formulario"},"Ahora vamos a hacer que se guarde en la BD, la informaci\xf3n que se env\xeda en el formulario:"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Configuramos el middleware para que se pueda leer el body, ya que el formulario utiliza el m\xe9todo POST"),(0,t.kt)("p",{parentName:"li"}," index.js"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const app = express();\n// Habilitamos los formularios html POST\napp.use(express.urlencoded({extended:true}))\n\n"))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Configuramos homeController.js para que a\xf1ada el dato enviado del formulario a la BD."),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const agregarUrl = async(req,res) => {\n   // La informacion enviada por el formulario\n   const {origin} = req.body;\n   try {\n       // Creamos una instancia(objeto) del modelo\n       // new Modelo({propiedades del esquema})\n       //shortUrl tiene un valor por defecto , no hace falta mandarlo\n      const url = new Url({origin:origin })\n      // Lo guardamos en la BD // Insertamos un documento(fila) en la colecci\xf3n(tabla)\n      await url.save();\n      // Direcciono a la pagina raiz\n      res.redirect('/');\n   } catch(error) {\n       console.log(error)\n       res.send(\"error algo fallo\");\n   }\n}\n\n"))),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Movemos la funcion nanoid() al homeController para que no genere conflictos ya que genera el mismo shortUrl para todos los documentos y no deja guardar mas de 2 veces"),(0,t.kt)("p",{parentName:"li"}," homeController.js"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// Importamos el modelo\nconst Url = require('../models/Url');\nconst {nanoid} = require('nanoid');\nconst agregarUrl = async(req,res) => {\n   // La informacion enviada por el formulario\n   const {origin} = req.body;\n   try {\n       // Creamos una instancia(objeto) del modelo\n       // new Modelo({propiedades del esquema})\n      const url = new Url({origin:origin , shortURL:nanoid(6)})\n       // Lo guardamos en la BD // Insertamos un documento(fila) en la colecci\xf3n(tabla)\n\n      await url.save();\n      // Direcciono a la pagina raiz\n      res.redirect('/');\n   } catch(error) {\n       console.log(error)\n       res.send(\"error algo fallo\");\n   }\n}\n  module.exports = {leerUrls , agregarUrl};\n\n")),(0,t.kt)("p",{parentName:"li"}," models/Url.js"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// Esquema\n// Nueva instancia(objeto) de Schema\n// El schema recibe un objeto con las propiedades que va a tener cada documento  y sus restricciones.\nconst urlSchema = new Schema({\n\n   origin: {\n       // La propiedad origen es de tipo String  , es unico , y es obligatorio\n       type: String,\n       unique: true,\n       required: true\n   },\n   shortURL: {\n     // La propiedad shortURL  es de tipo String , es unico , y es obligatorio.\n       type: String,\n       unique: true,\n       required: true,\n   }\n})\n\n")),(0,t.kt)("h2",{parentName:"li",id:"leer-datos"},"Leer datos"),(0,t.kt)("p",{parentName:"li"}," Ahora vamos a hacer que se muestre la informacion de la BD en la pagina de inicio(home)"),(0,t.kt)("p",{parentName:"li"}," views/components/Card.hbs"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},' <article class="card mb-2">\n       <div class="card-body">\n           <p>{{this.origin}}</p>\n           <p>{{this.shortURL}}</p>\n           <a href="#" class="btn btn-danger">Eliminar</a>\n           <a href="#" class="btn btn-warning">Editar</a>\n           <a href="#" class="btn btn-info">copiar</a>\n       </div>\n   </article>\n\n')),(0,t.kt)("p",{parentName:"li"}," controllers/homeController.js"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const leerUrls = async(req,res) => {\n  try {\n      // find() Busca todos los documentos de la coleccion(modelo)\n      // Select * from coleccion\n      // coleccion es el nombre del modelo\n     // Devuelve un array con objetos de mongoDB\n     //lean() convierte un objeto de mongoDB en un objeto JS\n     const urls = await Url.find().lean();\n     //urls:urls\n     res.render('home' , {urls:urls })\n  } catch (e) {\n      console.log(e);\n      res.send('fallo algo...');\n  }\n\n   }\n\n")))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"opcion Lean")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"La opci\xf3n Lean le dice a Mongoose que omita la hidrataci\xf3n de los documentos que contiene el  resultado de la consulta. Esto hace que las consultas sean m\xe1s r\xe1pidas y requieran menos memoria, pero los documentos se convierten en simples objetos JavaScript, no documentos Mongoose(objeto mongoDB)")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Cuando  guardamos un documento en la base de datos, usamos el m\xe9todo save() de  la instancia del modelo. El m\xe9todo save() pertenece a un objeto mongoDB(instancia del modelo) , esa es la diferencia entre un documento como objeto js (usando lean) y un documento como objeto mongoDB.")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"un objeto mongoDB === instancia del modelo")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"La opcion Lean le quita todos los metodos que contiene una instancia del Modelo  . Ej. le quita el metodo save()"))))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"hidratacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"La hidrataci\xf3n se refiere al proceso de llenar un objeto con datos. Un objeto que a\xfan no se ha hidratado se ha instanciado y representa una entidad que s\xed tiene datos, pero los datos a\xfan no se han cargado en el objeto. Esto es algo que se hace por razones de rendimiento."),(0,t.kt)("li",{parentName:"ul"},"Se podr\xeda decir que un objeto est\xe1 parcialmente hidratado cuando solo ha cargado algunos de los campos, pero no todos. Esto se puede hacer porque esos otros campos no son necesarios para sus operaciones actuales. Por lo tanto, no hay raz\xf3n para desperdiciar el ancho de banda y los ciclos de CPU cargando, transfiriendo y configurando estos datos cuando no se van a usar.")))),(0,t.kt)("h2",{id:"eliminar-datos"},"Eliminar datos"),(0,t.kt)("p",null," Ahora vamos a permitir que se puedan eliminar documentos en la BD:"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",{parentName:"li",href:"https://mongoosejs.com/docs/api.html#model_Model.findByIdAndDelete"},"Info"))),(0,t.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Forma no muy recomendada (utilizar peticion GET)"),(0,t.kt)("li",{parentName:"ul"},"Lo ideal seria utilizar una petici\xf3n DELETE ,  NO GET pero en HTML solo se puede hacer GET y POST")))),(0,t.kt)("p",null," views/components/Card.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},' <article class="card mb-2">\n       <div class="card-body">\n           <p>{{this.origin}}</p>\n           <p>{{this.shortURL}}</p>\n           <a href="/eliminar/{{item._id}}" class="btn btn-danger">Eliminar</a>\n           <a href="#" class="btn btn-warning">Editar</a>\n           <a href="#" class="btn btn-info">copiar</a>\n       </div>\n   </article>\n\n')),(0,t.kt)("p",null,"routes/home.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'// NO RECOMENDADO , para eliminacion informacion se usa el metodo DELETE\n// usar los dos puntos (:) para asignar una variable\n//ruta /eliminar/:nombrevariable\n//ruta /eliminar/valornombrevariable\n// Ejemplo: /eliminar/6220bd6df4eaa23f425ac827\n// nombrevariable  =  6220bd6df4eaa23f425ac827\nrouter.get("/eliminar/:id" , eliminarUrl);\nmodule.exports = router;\n\n')),(0,t.kt)("p",null,"homeController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const eliminarUrl = async(req,res) => {\n    // en req.params estan todas las variables  de rutas(:nombrevariable) y sus valores correspondiente\n    const {id} = req.params;\n    try {\n        // Busca una coleccion por la ID y lo elimina\n       await Url.findByIdAndDelete(id);\n       res.redirect('/');\n     } catch(error) {\n         console.log(error)\n         res.send(\"error algo fallo\");\n     }\n}\n\n   module.exports = {leerUrls , agregarUrl , eliminarUrl};\n\n")),(0,t.kt)("h2",{id:"validacion-con-middlewares"},"Validacion con middlewares"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"middlewares")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Intercepta la petici\xf3n antes de la respuesta del servidor (gesti\xf3n de rutas), incluso antes de que lo analice el servidor."),(0,t.kt)("li",{parentName:"ul"},"Se suele usar para las validaciones y autenticaciones."),(0,t.kt)("li",{parentName:"ul"},"Un middleware es una funci\xf3n con tres par\xe1metros (req , res , next)"),(0,t.kt)("li",{parentName:"ul"},"next = Siga con la siguiente solicitud, que la petici\xf3n pase a otro middleware o que llegue al servidor."),(0,t.kt)("li",{parentName:"ul"},"Se podr\xeda decir que el middleware es un cortafuego y si la petici\xf3n es v\xe1lida, pasa al servidor para ser tratada.")),(0,t.kt)("p",{parentName:"div"},"En caso que la petici\xf3n no sea v\xe1lida, nunca llega al servidor , sin embargo el middleware le env\xeda una respuesta al cliente."))),(0,t.kt)("p",null,"Creamos la carpeta middlewares y Adentro urlValida.js"),(0,t.kt)("p",null,"Para validar una Url"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",{parentName:"li",href:"https://nodejs.org/api/url.html#class-url"},"Usamos este modulo nativo de node.js"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},' \n // Modulo que viene incorporado con Node.js\nconst { URL } = require("url");\nconst urlValidar = (req,res , next) => {\n // Si todo esta correcto llamamos a next\n // next = eliminarUrl\n    try {\n        // Leo el body del formulario\n        const { origin } = req.body;\n        // Se crea una nueva instancia de URL con la informacion del formulario\n        const urlFrontend = new URL(origin);\n        //La instancia(objeto) tiene la propiedad origin\n        //Si es distinto a null , tiene el formato de url\n        if (urlFrontend.origin !== "null") {\n            // Comprueba que tenga el protocolo http o https y si lo tiene llama al next()\n            if (\n                urlFrontend.protocol === "http:" ||\n                urlFrontend.protocol === "https:"\n            ) {\n                return next();\n            }\n        }\n        // Lanzamos un error en caso que no sea valida\n        throw new Error("no v\xe1lida \ud83d\ude32");\n    } catch (error) {\n        // console.log(error);\n        return res.send("url no valida");\n    }\n};\n\nmodule.exports = urlValidar;\n\n')),(0,t.kt)("p",null,"routes/home.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'//Cuando se entra a la ruta , se ejecuta el middleware (urlValida).\n// El middleware lo analiza, si la peticion es valida, envia la peticion al agregarUrl(req,res)(pasa al siguiente - next).\n// En caso que la petici\xf3n es invalida , el middleware se encarga de responder a la peticion\nrouter.post("/" , urlValida , agregarUrl)\nrouter.get("/eliminar/:id"  , eliminarUrl);\n\nmodule.exports = router;\n\n')),(0,t.kt)("h2",{id:"editar-en-mongodb"},"Editar en MongoDB"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",{parentName:"li",href:"https://mongoosejs.com/docs/queries.html"},"Info"),(0,t.kt)("div",{parentName:"li",className:"admonition admonition-warning alert alert--danger"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Se hace con el m\xe9todo HTTP PUT pero en este ejemplo se realizara con GET (NO RECOMENDADO)"))),"routes/home.js")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'router.get("/eliminar/:id"  , eliminarUrl);\nrouter.get("/editar/:id", editarUrl);\nmodule.exports = router;\n\n')),(0,t.kt)("p",null,"homeController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"\nconst editarUrl = async(req,res) => {\n    //variable id de la ruta\n    const {id} = req.params;\n    try {\n        // En la coleccion(modelo) buscamos un documento cuya id sea igual al valor de la variable const id\n        // Como nos trae un objeto mongoDB lo convertirmos en un objeto JS con lean()\n       const url = await Url.findById(id).lean()\n       \n       // {url:url}\n       // el each del home.hbs ni se va a ejecutar ya que no le estamos pasando un array\n       res.render('home',{url})\n    } catch(error) {\n        console.log(error)\n        res.send(\"error algo fallo\");\n    }\n}\n   module.exports = {leerUrls , agregarUrl , eliminarUrl , editarUrl};\n\n")),(0,t.kt)("p",null,"En views/components/Card.hbs Modificamos el atributo href de editar"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'    <a href="/editar/{{item._id}}" class="btn btn-warning">Editar</a>\n')),(0,t.kt)("p",null," en views/components/Form.hbs"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"logica")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"  Si existe la url , crea una formulario para editar , si no existe crea el formulario para crear."))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'{{#if url}}\n   <form action="/editar/{{url._id}}" method="post">\n<input  value="{{url.origin}}" type="text" placeholder="Ingrese URL" name="origin" class="form-control my-2">\n<button type="submit" class="btn btn-warning w-100 mb-2">Editar</button>\n</form>\n{{else}}\n<form action="/" method="post">\n<input type="text" placeholder="Ingrese URL" name="origin" class="form-control my-2">\n<button type="submit" class="btn btn-primary w-100 mb-2">Agregar Url</button>\n</form>\n\n{{/if}}\n\n')),(0,t.kt)("p",null," home.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const {leerUrls , agregarUrl , eliminarUrl , editarUrlForm , editarUrl} = require(\'../controllers/homeController\')\n\nrouter.get("/" , leerUrls)\n//Cuando se entra a la ruta , se ejecuta el middleware (urlValida).\n// Si el middleware detecta que la  peticion es valida, envia la peticion a agregarUrl(req,res)(al siguiente - next)\nrouter.post("/" , urlValida , agregarUrl)\nrouter.get("/eliminar/:id"  , eliminarUrl);\nrouter.get("/editar/:id", editarUrlForm);\n// Utiliza el middleware\n// Si la url es valida , la petici\xf3n la gestiona editarUrl(req,res)\nrouter.post("/editar/:id" ,urlValida ,  editarUrl)\nmodule.exports = router;\n\n')),(0,t.kt)("p",null," homeController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// Importamos el modelo\nconst Url = require('../models/Url');\nconst {nanoid} = require('nanoid');\n\nconst leerUrls = async(req,res) => {\n  try {\n      // find(parametros opcionales) Busca todos los documentos de la coleccion(modelo)\n      // Select * from coleccion\n     // Puede tener parametros para filtrar documentos\n     // Devuelve un array con objetos de mongoDB\n     //lean() convierte un objeto de mongoDB en un objeto JS\n     const urls = await Url.find().lean();\n     //urls:urls\n     res.render('home' , {urls:urls })\n  } catch (e) {\n      console.log(e);\n      res.send('fallo algo...');\n  }\n\n   }\nconst agregarUrl = async(req,res) => {\n   const {origin} = req.body;\n   try {\n      const url = new Url({origin:origin , shortURL:nanoid(6)})\n      await url.save();\n      res.redirect('/');\n   } catch(error) {\n       console.log(error)\n       res.send(\"error algo fallo\");\n   }\n}\nconst eliminarUrl = async(req,res) => {\n   // en req.params estan todas las variables  de ruta(:nombrevariable) y sus valores correspondiente\n   const {id} = req.params;\n   try {\n       // Busca una coleccion por la ID y lo elimina\n      await Url.findByIdAndDelete(id);\n      res.redirect('/');\n    } catch(error) {\n        console.log(error)\n        res.send(\"error algo fallo\");\n    }\n}\n\nconst editarUrlForm = async(req,res) => {\n   //variable id de la ruta\n   const {id} = req.params;\n   try {\n       // En la coleccion(modelo) buscamos un documento cuya id sea igual al valor de la variable const id\n       // Como nos trae un objeto mongoDB lo convertirmos en un objeto JS con lean()\n      const url = await Url.findById(id).lean()\n      \n      // {url:url}\n      // el each del home.hbs ni se va a ejecutar ya que no le estamos pasando un array\n      res.render('home',{url})\n   } catch(error) {\n       console.log(error)\n       res.send(\"error algo fallo\");\n   }\n}\nconst editarUrl = async(req,res) => {\n   //variable id de la ruta\n   const {id} = req.params;\n   const {origin} = req.body;\n   try {\n       // Buscamos el documento por la id y lo actualizamos\n       //findByIdAndUpdate(id , {informacion a modificar} )\n       // origin : origin\n      await Url.findByIdAndUpdate(id, {origin})\n      res.redirect('/');\n   \n   } catch(error) {\n       console.log(error)\n       res.send(\"error algo fallo\");\n   }\n}\n  module.exports = {leerUrls , agregarUrl , eliminarUrl , editarUrlForm , editarUrl};\n\n")),(0,t.kt)("h2",{id:"clipboard"},"clipboard"),(0,t.kt)("p",null," Para copiar en el portapapeles la urlShort vamos a trabajar con el frontend"),(0,t.kt)("p",null," Card.hbs:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},' <article class="card mb-2">\n        <div class="card-body">\n            <p>{{this.origin}}</p>\n            <p>{{this.shortURL}}</p>\n            <a href="/eliminar/{{item._id}}" class="btn btn-danger">Eliminar</a>\n            <a href="/editar/{{item._id}}" class="btn btn-warning">Editar</a>\n            <button data-short="{{item.shortURL}}" href="#" class="btn btn-info">copiar</button>\n        </div>\n    </article>\n\n')),(0,t.kt)("p",null,"main.hbs:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'  <script src="/js/app.js"><\/script>\n</body>\n</html>\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"A partir de ahora trabajamos con el frontend"))),(0,t.kt)("p",null,"public/js/app.js:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'document.addEventListener(\'click\' , e => {\n    \n    if (e.target.dataset.short) {\n         const url = `http://localhost:5000/${e.target.dataset.short}`;\n         // Usamos el clipboard para copiar la const url  en el portapapeles\n         // Que se copie(Control + C) para luego pegar la url en donde quieras\n         navigator.clipboard\n            .writeText(url)\n            .then(() => {\n                console.log("Text copied to clipboard...");\n            })\n            .catch((err) => {\n                console.log("Something went wrong", err);\n            });\n    }\n})\n\n')),(0,t.kt)("h2",{id:"redireccionamiento"},"Redireccionamiento"),(0,t.kt)("p",null,"Vamos a hacer  que el short te lleve a la url indicada (origin)"),(0,t.kt)("p",null,"routes/home.js:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"\nconst {leerUrls , agregarUrl , eliminarUrl , editarUrlForm , editarUrl , redireccionamiento} = require('../controllers/homeController' )\nrouter.get(\"/:url\" , redireccionamiento)\nmodule.exports = router;\n\n")),(0,t.kt)("p",null,"homeController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const redireccionamiento = async(req,res) => {\n    const {url} = req.params\n    try {\n       // Modificar en la documentacion\n       const urlDB = await Url.findOne({shortURL: url })\n       res.redirect(urlDB.origin);\n    } catch(error) {\n        req.flash("mensajes" , [{msg: "No existe esta url configurada"}]);\n        return res.redirect(\'/auth/login\')\n    }\n}\n   module.exports = {leerUrls , agregarUrl , eliminarUrl , editarUrlForm , editarUrl , redireccionamiento};\n\n')),(0,t.kt)("h2",{id:"registrar-usuario"},"Registrar usuario"),(0,t.kt)("p",null,"controllers/authController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"\nconst User = require(\"../models/User\")\nconst {nanoid} = require('nanoid');\nconst loginForm = (req,res) => {\n       res.render('login')\n}\n\nconst registerForm = (req,res) => {\n      res.render('register')\n}\nconst registerUser = async (req,res) => {\n    const {userName , email , password} = req.body\n    try {\n        // Buscamos un usuario por el email\n       let user = await User.findOne({email:email});\n       // Si existe el usuario , retornamos un error\n       if (user) throw new Error('ya existe el usuario');\n       // Si no existe , creamos una instancia del modelo\n// userName:userName , email:email , password:password\n      user = new User({userName , email , password  , tokenConfirm: nanoid()});\n      user.save()\n      res.json(user);\n    } catch(e) {\n        res.json({error: e.message});\n    }\n}\n\nmodule.exports = {\n    loginForm , registerForm , registerUser\n}\n\n")),(0,t.kt)("p",null,"routes/auth.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const express = require(\'express\');\nconst { loginForm, registerForm, registerUser } = require(\'../controllers/authController\');\nconst router = express.Router();\nrouter.get("/login", loginForm);\n//Respondemos una peticion GET  a auth/register \nrouter.get("/register", registerForm);\n// Respondemos una peticion POST  a auth/register \nrouter.post("/register" , registerUser);\nmodule.exports = router;\n\n')),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"http://localhost:5000/auth/login")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"http://localhost:5000/auth/register"))),(0,t.kt)("p",null,"views/register.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<h1 class="text-center my-5">Registro de usuarios nuevos</h1>\n<div class="row justify-content-center">\n    <div class="col-md-6">\n        <form action="/auth/register" method="post">\n            <input type="text" placeholder="Ingrese nombre" class="form-control mb-2" value="usuario" name="userName">\n            <input type="text" placeholder="Ingrese email" name="email" class="form-control mb-2"\n                value="usuario@test.com">\n            <input type="password" placeholder="Ingrese password" name="password" class="form-control mb-2"\n                value="123123">\n            <input type="password" placeholder="Repita password" name="repassword" class="form-control mb-2"\n                value="123123">\n            <button class="btn btn-primary" type="submit">Registrar usuario</button>\n        </form>\n    </div>\n</div>\n\n')),(0,t.kt)("h2",{id:"respuestas"},"Respuestas"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"res.render() = Renderizar(Convertir en html) un archivo"),(0,t.kt)("li",{parentName:"ul"},"res.json() = Para responder en json"),(0,t.kt)("li",{parentName:"ul"},"res.send() = Para responder de forma sencilla.")),(0,t.kt)("h2",{id:"modelo-usuario"},"Modelo Usuario"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Definir el esquema sirve para hacer validaciones de DB"),(0,t.kt)("li",{parentName:"ul"},"junt\xe1ndolo con las validaciones del backend y frontend la app es muy segura."),(0,t.kt)("li",{parentName:"ul"},"Si no se respeta la estructura(esquema) a la hora de crear un documento, se genera un error.\nmodels/User.js")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const mongoose = require('mongoose')\n// Obtenemos la clase Schema de mongosee\nconst {Schema} = mongoose\n\nconst UserSchema = new Schema({\n    // Estructura de los documentos\n   //columna/propiedad userName\n   // Es de tipo String ,y obligatorio\n   // Se convierte en minuscula el valor\n   userName: {\n       type:String,\n       lowercase:true,\n       required:true,\n   } ,\n   //columna/propiedad email\n   // Es de tipo String , obligatorio y unico\n   // Se convierte en minuscula el valor\n   email: {\n    type:String,\n    lowercase:true,\n    required:true ,\n    unique : true ,\n    // Indexar\n    index: {unique : true} , \n} ,\n//columna/propiedad password\n   // Es de tipo String y obligatorio \npassword: {\n    type:String ,\n    required : true ,\n\n} ,\n//columna/propiedad tokenConfirm\n   // Es de tipo String \n   // Valor por defecto: null\ntokenConfirm : {\n    type:String ,\n    default:null,\n} ,\n//columna/propiedad cuentaConfirmada\n   // Es de tipo boolean \n   // Valor por defecto: false\ncuentaConfirmada: {\n    type:Boolean,\n    default:false\n}\n\n})\n// Llevamos el esquema hacia un modelo y lo exportamos\nmodule.exports = mongoose.model(\"User\" , UserSchema)\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"La exportaci\xf3n se hace por defecto , por lo tanto se le puede cambiar el nombre al importarlo."),(0,t.kt)("li",{parentName:"ul"},"Al momento de instanciar un modelo, solo las propiedades que contiene el esquema se van a instanciar y no propiedades inexistentes.")))),(0,t.kt)("h2",{id:"cifrar-la-contrase\xf1a"},"Cifrar la contrase\xf1a"),(0,t.kt)("h3",{id:"creamos-un-hash"},"Creamos un hash"),(0,t.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"NUNCA GUARDAR LA CONTRASE\xd1A EN TEXTO PLANO"))),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Usamos el modulo ",(0,t.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/bcryptjs"},"bcryptjs"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i bcryptjs\n")),(0,t.kt)("h3",{id:"tutorial-de-bycriptjs"},"Tutorial de bycriptjs"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"Importarlo"),(0,t.kt)("li",{parentName:"ol"},"Generar saltos ")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Los saltos son como palabras aleatorias que se generan a partir de la contrase\xf1a para que no se pueda descifrar la misma"),(0,t.kt)("li",{parentName:"ul"},"Mientras el valor sea m\xe1s alto , m\xe1s recursos consume pero brinda mas seguridad"),(0,t.kt)("li",{parentName:"ul"},"La cantidad de veces que se va a encriptar la contrase\xf1a en cadena.")),(0,t.kt)("ol",{start:3},(0,t.kt)("li",{parentName:"ol"},"Encriptamos la contrase\xf1a con los saltos.")),(0,t.kt)("p",null,"Se recomienda usar el async"),(0,t.kt)("h2",{id:"pre-mongosee"},"pre mongosee"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",{parentName:"li",href:"https://mongoosejs.com/docs/api.html#schema_Schema-pre"},"info")),(0,t.kt)("li",{parentName:"ul"},"Es  un hook(gancho) "),(0,t.kt)("li",{parentName:"ul"},"Sintaxis : Esquema.pre(\u2018accion\u2019 , function ) "),(0,t.kt)("li",{parentName:"ul"},"El pree mongosee  sirve para ejecutar una funci\xf3n antes de una acci\xf3n."),(0,t.kt)("li",{parentName:"ul"},"La funci\xf3n tiene como par\xe1metro el next que cumple la misma funci\xf3n que el del middleware. (en este caso que ejecute la \u2018accion\u2019)"),(0,t.kt)("li",{parentName:"ul"},"La funci\xf3n no debe ser una funci\xf3n flecha ya que utiliza el this para acceder al esquema.")),(0,t.kt)("p",null,"Con pre vamos a hacer que  antes que se guarde en la BD, haga alguna acci\xf3n (en nuestro caso encriptar)."),(0,t.kt)("p",null,"models/User.js:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const bycript = require('bcryptjs');\nconst mongoose = require('mongoose')\n// Obtenemos la clase Schema de mongosee\nconst {Schema} = mongoose\n\nconst UserSchema = new Schema({\n    // Estructura de los documentos\n  // Si no se respeta la estructura a la hora de crear un documento, se genera un error.\n   //columna/propiedad userName\n   // Es de tipo String ,y obligatorio\n   // Se convierte en minuscula el valor\n   userName: {\n       type:String,\n       lowercase:true,\n       required:true,\n   } ,\n   //columna/propiedad email\n   // Es de tipo String , obligatorio y unico\n   // Se convierte en minuscula el valor\n   email: {\n    type:String,\n    lowercase:true,\n    required:true ,\n    unique : true ,\n    // Indexar\n    index: {unique : true} , \n} ,\n//columna/propiedad password\n   // Es de tipo String y obligatorio \npassword: {\n    type:String ,\n    required : true ,\n\n} ,\n//columna/propiedad tokenConfirm\n   // Es de tipo String \n   // Valor por defecto: null\ntokenConfirm : {\n    type:String ,\n    default:null,\n} ,\n//columna/propiedad cuentaConfirmada\n   // Es de tipo boolean \n   // Valor por defecto: false\ncuentaConfirmada: {\n    type:Boolean,\n    default:false\n}\n\n})\n// Se va a ejecutar  funcion() antes de llamar a nombrefuncion()\n// Entonces cuando se llame a nombrefuncion() , tambien es llamada funcion()\n// pre(nombrefuncion , funcion)\nuserSchema.pre('save' , async function(next){\n // Al ser una una instancia , podemos usar el this\n   const user = this\n   //Si la contrase\xf1a no ha sido modificada , que siga (llame al nombrefuncion())\n   if (!user.isModified('password')) return next();\n   // Si la contrase\xf1a fue modificada o es nueva la contrase\xf1a\n   try {\n       // Especificamos la cantidad de saltos \n       const salt = await bycript.genSalt(10)\n       // Ciframos la contrase\xf1a\n       const hash = await bycript.hash(user.password , salt);\n      \n       user.password = hash;\n       // Que ejecute nombrefuncion()\n       next();\n   } catch(error) {\n       console.log(error);\n       next()\n   }\n\n})\n\n\n// Llevamos el esquema hacia un modelo y lo exportamos\nmodule.exports = mongoose.model(\"User\" , UserSchema)\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"logica")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Antes que se guarde el usuario en la BD , se cifra la contrase\xf1a"))),(0,t.kt)("h2",{id:"confirmarcuenta"},"ConfirmarCuenta"),(0,t.kt)("p",null,"routes/auth.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const { loginForm, registerForm, registerUser, confirmarCuenta } = require('../controllers/authController');\n// Respondemos una peticion GET a auth/confirmarCuenta/xxxxxxx\n// variable token = xxxxxxx\nrouter.get(\"/confirmarCuenta/:token\" , confirmarCuenta )\nmodule.exports = router;\n\n")),(0,t.kt)("p",null,"controllers/authController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const registerUser = async (req,res) => {\n    const {userName , email , password} = req.body\n    try {\n        // Buscamos un usuario por el email\n       let user = await User.findOne({email:email});\n       // Si existe el usuario , retornamos un error\n       if (user) throw new Error('ya existe el usuario');\n       // Si no existe , creamos una instancia del modelo\n      user = new User({userName , email , password  , tokenConfirm: nanoid()});\n      user.save()\n    res.redirect('/auth/login');\n\n\n    } catch(e) {\n        res.json({error: e.message});\n    }\n}\nconst confirmarCuenta = async(req,res) => {\n\n}\nmodule.exports = {\n    loginForm , registerForm , registerUser , confirmarCuenta\n}\n\n")),(0,t.kt)("p",null,"Modificamos confirmarCuenta:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const confirmarCuenta = async(req,res) => {\n   \n   //Leemos las variables de la ruta (variable token en este caso)\n  const {token} = req.params;\n\n  try {\n      // Buscamos el usuario por el token(tokenConfirm) en la BD\n      \n       const user = await User.findOne({tokenConfirm:token});\n       // Si no existe el usuario\n       if (!user) throw new Error('No existe el usuario')\n       // Si existe el usuario\n       // Confirmamos la cuenta\n       user.cuentaConfirmada = true;\n       // Eliminamos el tokenConfirm\n       user.tokenConfirm = null;\n       // Lo guardamos en la BD\n       // el metodo save() lo contiene el objeto de mongoDB user\n       await user.save();\n       res.redirect('/auth/login');\n  }catch(error) {\n    res.json({error: error.message});\n  }\n}\n\n")),(0,t.kt)("h2",{id:"iniciar-sesion"},"Iniciar sesion"),(0,t.kt)("p",null,"views/login.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'\n<h1 class="text-center my-5">Login de usuarios</h1>\n<div class="row justify-content-center">\n    <div class="col-md-6">\n        <form action="/auth/login" method="post">\n          \n            <input type="text" placeholder="Ingrese email" name="email" class="form-control mb-2"\n                value="usuario@test.com">\n            <input type="password" placeholder="Ingrese password" name="password" class="form-control mb-2"\n                value="123123">\n           \n            <button class="btn btn-primary" type="submit">Acceder</button>\n        </form>\n    </div>\n</div>\n\n')),(0,t.kt)("p",null,"routes/auth.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'\nconst { loginForm, registerForm, registerUser, confirmarCuenta , loginUser } = require(\'../controllers/authController\');\nrouter.get("/login", loginForm);\nrouter.post("/login", loginUser);\n\n')),(0,t.kt)("p",null,"controllers/authController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const registerForm = (req,res) => {\n      res.render('register')\n}\nconst loginUser = async (req,res) => {\n  \n}\nmodule.exports = {\n    loginForm , registerForm , registerUser , confirmarCuenta , loginUser\n}\n\n")),(0,t.kt)("h2",{id:"a\xf1adirle-metodos-al-esquema-mongodb"},"A\xf1adirle metodos al esquema mongoDB"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Le a\xf1adimos un m\xe9todo adicional al esquema, el cual lo adquiere el modelo posteriormente.\nmodels/User.js")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'//esquema.methods.nombre_metodo = funcion\n// Le a\xf1adimos un metodo   lllamada comparePassword al esquema\n// Tenemos acceso al this al ser un metodo \nUserSchema.methods.comparePassword = async function(password) {\n    //bycript.compare(contrase\xf1a , clave cifrada(hash))\n    // Compara una contrase\xf1a no cifrada con una cifrada\n    return await bycript.compare(password , this.password)\n}\n\n// Llevamos el esquema hacia un modelo y lo exportamos\nmodule.exports = mongoose.model("User" , UserSchema)\n\n')),(0,t.kt)("p",null,"Modificamos el loginUser(req,res) de authController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"\nconst loginUser = async (req,res) => {\n  const {email,password} = req.body;\n  try {\n    // email:email\n      const user = await User.findOne({email})\n      //Si no existe el usuario \n      if (!user) throw new Error('No existe este email');\n      // Si existe el usuario\n      // Verifica que la cuenta esta confirmada\n      if (!user.cuentaConfirmada) throw new Error('Falta confirmar cuenta');\n      //Usamos el metodo que creamos\n      //Que devuelve true si la contrase\xf1a es correcta\n      // Verifica que la contrase\xf1a sea valida\n      if (!await user.comparePassword(password)) throw new Error('Contrase\xf1a no correcta');\n      // Y si llego hasta aca , el usuario el valido\n      res.redirect('/');\n  } catch(error) {\n         console.log(error);\n         res.send(error.message);\n  }\n}\n\nmodule.exports = {\n    loginForm , registerForm , registerUser , confirmarCuenta , loginUser\n}\n\n\n")),(0,t.kt)("h2",{id:"favicon"},"Favicon"),(0,t.kt)("p",null,"en la carpeta public/img ponemos la imagen"),(0,t.kt)("p",null,"quedando: public/img/favicon.ico"),(0,t.kt)("p",null,"main.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Desde HBS</title>\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">\n     <link rel="icon" type="image/x-icon" href="/img/favicon.ico">\n</head>\n\n')),(0,t.kt)("p",null,"navbar.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},' <a class="nav-link" href="/auth/register">Register</a>\n        <a class="nav-link" href="/auth/login">Login</a>\n        <a class="nav-link" href="/auth/logout">LogOut</a>\n\n')),(0,t.kt)("h2",{id:"session"},"Session"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"El middleware express-session almacena los datos de sesi\xf3n en el servidor; s\xf3lo guarda el ID de sesi\xf3n en la propia cookie, no los datos de sesi\xf3n. De forma predeterminada, utiliza el almacenamiento en memoria y no est\xe1 dise\xf1ado para un entorno de producci\xf3n."),(0,t.kt)("li",{parentName:"ul"},"En una api rest NO SE DEBE trabajar con esto",(0,t.kt)("div",{parentName:"li",className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"middleware")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Se ejecute antes que la petici\xf3n llegue al servidor y la gestione.")))),(0,t.kt)("li",{parentName:"ul"},"Usaremos el modulo ",(0,t.kt)("a",{parentName:"li",href:"http://expressjs.com/en/resources/middleware/session.html"},"express-sesion")," para trabajar con la sesiones en express"),(0,t.kt)("li",{parentName:"ul"},"Usaremos el modulo ",(0,t.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/connect-mongo"},"connect-mongo")," para guardar la sesion en la BD")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i express-session\nnpm i connect-mongo\n\n")),(0,t.kt)("h3",{id:"ejemplo"},"Ejemplo"),(0,t.kt)("p",null,"index.js "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const session = require("express-session");\nconst express = require("express");\nconst { create } = require("express-handlebars");\n require(\'dotenv\').config()\n  require(\'./database/conexion\');\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\nconst app = express();\n// Configuramos la sesion con el middleware.\napp.use(\n  session({\n      secret: \'palabra secreta\',\n      // Para tratar errores\n      resave: false,\n      saveUninitialized: false,\n      name: "nombre de la palabra secreta"\n  })\n);\napp.get("/ruta-protegida" , (req,res) => {\n  // Si existe una sesion devolvemos el usuario , en caso contrario mandamos "Sin sesion de usuario"\n  res.json(req.session.usuario || "Sin sesion de usuario")\n})\napp.get(\'/crear-session\' , (req,res) => {\n  // Creamos la sesion\n  req.session.usuario = "usuario";\n  res.redirect(\'/ruta-protegida\');\n})\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"La sesion se crea en la memoria (nuestra maquina)"))),(0,t.kt)("p",null,"Tambien podemos destruir la sesion:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"app.get(\"/ruta-protegida\" , (req,res) => {\n  // Si existe una sesion devolvemos el usuario , en caso contrario mandamos \"Sin sesion de usuario\"\n  res.json(req.session.usuario || \"Sin sesion de usuario\")\n})\napp.get('/crear-session' , (req,res) => {\n  // Creamos la sesion\n  req.session.usuario = \"usuario\";\n  res.redirect('/ruta-protegida');\n})\napp.get('/destruir-sesion' , (req,res) => {\n  // Destruirmos la sesion\n  req.session.destroy();\n  res.redirect('/ruta-protegida');\n})\n\n")),(0,t.kt)("h2",{id:"flash"},"Flash"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"El flash es un \xe1rea especial de la sesi\xf3n que se utiliza para almacenar mensajes. Los mensajes se escriben en la memoria flash y se borran despu\xe9s de mostrarse al usuario. El flash generalmente se usa en combinaci\xf3n con redireccionamientos, lo que garantiza que el mensaje est\xe9 disponible para la siguiente p\xe1gina que se va a representar."),(0,t.kt)("li",{parentName:"ul"},"Viven solamente en una redirecci\xf3n. Si se navega en otro lado se destruye."),(0,t.kt)("li",{parentName:"ul"},"Usaremos el modulo ",(0,t.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/connect-flash"},"connect-flash")," para trabajar con flash"),(0,t.kt)("li",{parentName:"ul"},"Es un tipo de sesion , que solo vive una vez (en una redirecci\xf3n)")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i connect-flash\n")),(0,t.kt)("h3",{id:"ejemplo-1"},"Ejemplo"),(0,t.kt)("p",null,"index.js "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const session = require("express-session");\nconst flash = require("connect-flash");\nconst express = require("express");\nconst { create } = require("express-handlebars");\n require(\'dotenv\').config()\n  require(\'./database/conexion\');\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\nconst app = express();\n// Configuramos la sesion con el middleware.\napp.use(\n  session({\n      secret: \'palabra secreta\',\n      resave: false,\n      saveUninitialized: false,\n      name: "nombre de secreto"\n  })\n);\n// Configuramos flash con el middleware\napp.use(flash());\napp.get(\'/mensaje-flash\' , (req, res) => {\n  // Muestra un mensaje flash cuya key es "mensaje"\n  res.json(req.flash(\'mensaje\'))\n})\napp.get(\'/crear-mensaje\' , (req, res) => {\n  //flash( key , valor)\n  // La key contiene el valor\n  // key -> valor\n  //"mensaje" -> "este es un mensaje"\n  req.flash("mensaje" , "este es un mensaje")\n  res.redirect(\'/mensaje-flash\');\n})\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"A diferencia de session-express, la sesion solo dura en la redirecci\xf3n (solo una url)"),(0,t.kt)("li",{parentName:"ul"},"Solo viven en una url."),(0,t.kt)("li",{parentName:"ul"},"Cuando llamas un mensaje flash, se destruye"),(0,t.kt)("li",{parentName:"ul"},"Flash requiere de la configuraci\xf3n de la sesion (express-sesion)")))),(0,t.kt)("h2",{id:"validacionesexpress-validator"},"Validaciones(Express-validator)"),(0,t.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Aclaracion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Los dos ejemplos anteriores(sesion y flash) no forman parte del proyecto "),(0,t.kt)("li",{parentName:"ul"},"Flash y Session se usaran  para mostrar los mensajes de errores de las validaciones")))),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Vamos a usar el modulo ",(0,t.kt)("a",{parentName:"li",href:"https://express-validator.github.io/docs/"},"express-validator")," que nos sirve para validar")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i express-validator\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Objetivo")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Antes que se guarde un usuario en la BD , vamos a validar los datos."))),(0,t.kt)("p",null,"routes/auth.js"),(0,t.kt)("p",null,"Configuramos una validacion del nombre usuario:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const {body} = require(\'express-validator\');\n// Tiene un array de middleware\nrouter.post("/register" ,  [\n    \n    // body ("valor-atributoname/propiedad" , "mensaje de error").metodo.metodo.metodo....\n    // valor-atributoname/propiedad = corresponde a una propiedad del body(los datos se envian por el body) que se va a evaluar\n    // trim() = Limpia los espacios en blanco del lado izquierda y derecho\n    // notEmpty()  = Para que no venga vacio \n    // escape() = Para que solo mande caracteres y ignore html\n    body("userName" , "Ingrese un nombre v\xe1lido").trim().notEmpty().escape(),\n] ,  registerUser);\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Un array de middleware sirve para implementar muchos middleware en una ruta"))),(0,t.kt)("p",null,"authController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const {validationResult } = require('express-validator');\nconst registerUser = async (req,res) => {\n  // Hace la validacion que hemos configurado\n  const errors = validationResult(req);\n  //Si tiene errores , los devuelve\n  if (!errors.isEmpty()) {\n    return res.json(errors);\n  }\n    const {userName , email , password} = req.body\n\n")),(0,t.kt)("p",null,"Configuramos las demas Validaciones:"),(0,t.kt)("p",null,"routes/auth.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'// Tiene un array de middleware\nrouter.post("/register" ,  [\n   // body ("valor-atributoname/propiedad" , "mensaje de error").metodo.metodo.metodo....\n    // valor-atributoname/propiedad = corresponde a una propiedad del body(los datos se envian por el body) que se va a evaluar\n    // trim() = Limpia los espacios en blanco del lado izquierda y derecho\n    // notEmpty()  = Para que no venga vacio d\n    // escape() = Para que solo mande caracteres y ignore html\n    body("userName" , "Ingrese un nombre v\xe1lido").trim().notEmpty().escape(), \n    //Validamos el email  para que tenga un formato valido\n    body("email" , "Ingrese un email valido").trim().isEmail().normalizeEmail() ,\n    //validamos la contrase\xf1a \n    body("password" , "Contrase\xf1a de minimo 6 caracteres").trim().isLength({min:6}).escape()\n    // Hacemos una validacion personalizada para que las dos contrase\xf1as coincida\n    // custom(funcion(value , {req})) \n    // el value es lo que se evalua (lo que se envia en el formulario)\n    // {req} es para tener acceso al req(requirimiento)\n    .custom((value , {req}) =>{\n        // SI no son iguales\n        \n       if (value !== req.body.repassword) {\n           // No cumple la validacion\n           //Este seria el mensaje de error que se mandaria\n           throw new Error("No coinciden las contrase\xf1as")\n       }\n       // Si cumple la validacion\n       return value\n    })\n] ,  registerUser);\n\n\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Si se cumple la validaci\xf3n , no devuelve nada"),(0,t.kt)("li",{parentName:"ul"},"Si no se cumple , devuelve el mensaje de error.")))),(0,t.kt)("h3",{id:"validamos-el-login-tambi\xe9n"},"Validamos el login tambi\xe9n:"),(0,t.kt)("p",null,"routes/auth.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'router.post("/login", [body("email" , "Ingrese un email valido").trim().isEmail().normalizeEmail() ,  body("password" , "Contrase\xf1a de minimo 6 caracteres").trim().isLength({min:6}).escape()\n ] , loginUser);\n\n')),(0,t.kt)("p",null,"authController.js:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const loginUser = async (req,res) => {\n  // Hace la validacion que hemos configurado\n  const errors = validationResult(req);\n  //Si tiene errores , los devuelve\n  if (!errors.isEmpty()) {\n    return res.json(errors);\n  }\n  const {email,password} = req.body;\n\n")),(0,t.kt)("h2",{id:"validaciones-en-la-vista"},"Validaciones en la vista"),(0,t.kt)("p",null,"Ponemos las Validaciones en la vista:"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Ahora si vamos a usar flash y session."))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"array()")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Usamos el m\xe9todo array() el cual lo convierte en array.\nEmpezamos con el login:"))),(0,t.kt)("p",null,"authController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const loginForm = (req,res) => {\n       res.render('login' , {mensajes : req.flash(\"mensajes\")})\n}\nconst loginUser = async (req,res) => {\n  // Hace la validacion que hemos configurado\n  const errors = validationResult(req);\n  //Si tiene errores , los devuelve\n  if (!errors.isEmpty()) {\n    req.flash(\"mensajes\" , errors.array());\n    return res.redirect('/auth/login')\n  }\n  const {email,password} = req.body;\n  try {\n    // email:email\n      const user = await User.findOne({email})\n      //Si no existe el usuario \n      if (!user) throw new Error('No existe este email');\n      // Si existe el usuario\n      // Verifica que la cuenta esta confirmada\n      if (!user.cuentaConfirmada) throw new Error('Falta confirmar cuenta');\n      //Usamos el metodo que creamos\n      //Que devuelve true si la contrase\xf1a es correcta\n      // Verifica que la contrase\xf1a sea valida\n      if (!await user.comparePassword(password)) throw new Error('Contrase\xf1a incorrecta');\n      // Y si llego hasta aca , el usuario el valido\n      res.redirect('/');\n  } catch(error) {\n    req.flash(\"mensajes\" , [{msg: error.message}]);\n    return res.redirect('/auth/login')\n  }\n}\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Los valores que se mandan a la vista pueden ser null "),(0,t.kt)("li",{parentName:"ul"},"Si no se manda un valor , se considera null")))),(0,t.kt)("p",null,"views/layouts/main.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'<body>\n    {{> Navbar}}\n    <div class="container mt-5">\n      {{#each mensajes }}\n              <div class="alert alert-dark mb-2"> {{this.msg}}</div>\n      {{/each}}\n\n      \n {{{body}}}\n    </div>\n     \n      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"><\/script>\n      <script src="/js/app.js"><\/script>\n</body>\n\n')),(0,t.kt)("p",null,"Ahora lo hacemos en el registro"),(0,t.kt)("p",null,"authController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const registerForm = (req,res) => {\n      res.render('register' , {mensajes : req.flash(\"mensajes\")})\n}\nconst registerUser = async (req,res) => {\n  // Hace la validacion que hemos configurado\n  const errors = validationResult(req);\n  //Si tiene errores , los devuelve\n  if (!errors.isEmpty()) {\n    req.flash(\"mensajes\" , errors.array());\n    return res.redirect('/auth/register')\n  }\n    const {userName , email , password} = req.body\n    try {\n        // Buscamos un usuario por el email\n       let user = await User.findOne({email:email});\n       // Si existe el usuario , retornamos un error\n       if (user) throw new Error('ya existe el usuario');\n       // Si no existe , creamos una instancia del modelo\n      user = new User({userName , email , password  , tokenConfirm: nanoid()});\n      user.save()\n      req.flash(\"mensajes\" , [{msg: \"Revisa tu correo electronico y valida cuenta\"}]);\n      res.redirect('/auth/login');\n    } catch(error) {\n      req.flash(\"mensajes\" , [{msg: error.message}]);\n      return res.redirect('/auth/register')\n    }\n}\n\n")),(0,t.kt)("p",null,"Hacemos lo mismo en la ruta de confirmarCuenta"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const confirmarCuenta = async(req,res) => {\n   \n   //Leemos las variables de la ruta (variable token en este caso)\n  const {token} = req.params;\n\n  try {\n      // Buscamos el usuario por el token en la BD\n      \n       const user = await User.findOne({tokenConfirm:token});\n       // Si no existe el usuario\n       if (!user) throw new Error('No existe el usuario')\n       // Si existe el usuario\n       // Confirmamos la cuenta\n       user.cuentaConfirmada = true;\n       // Eliminamos el tokenConfirm\n       user.tokenConfirm = null;\n       // Lo guardamos en la BD\n       // el metodo save() lo contiene el objeto de mongoDB user\n       await user.save();\n       req.flash(\"mensajes\" , [{msg: \"Cuenta verificada\"}]);\n       res.redirect('/auth/login');\n  }catch(error) {\n    req.flash(\"mensajes\" , [{msg: error.message}]);\n    return res.redirect('/auth/login')\n  }\n}\n\n\n")),(0,t.kt)("h2",{id:"passport"},"Passport"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Podemos gestionar nosotros las sesiones o que las gestione un tercero como Passport"),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",{parentName:"li",href:"http://www.passportjs.org"},"Passport"),"  es un modulo que te permite gestionar sesiones , ofrece un mont\xf3n de estrategias para validar al usuario. Pero en el proyecto solo vamos a configurar Passport para que gestione las sesiones.")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm install passport\n")),(0,t.kt)("h3",{id:"reqlogin"},"req.login()"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Lo genera passport con las configuraciones que tiene configurada"),(0,t.kt)("li",{parentName:"ul"},"Sirve para crear una sesion"),(0,t.kt)("li",{parentName:"ul"},"Le manda el usuario a la funci\xf3n serializeUser para crear el req.user")),(0,t.kt)("h3",{id:"serializeruser"},"serializerUser()"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Es una funcion que invoca req.login()"),(0,t.kt)("li",{parentName:"ul"},"Crea la sesion con la ID y el nombre del usuario (los datos se pueden configurar)")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// Recibe un callback con dos parametros \n// user = el usuario que le vamos a enviar \n// done = Para decirle que se hizo con exito\npassport.serializeUser((user , done) => {\n  // done (errores , {los datos que van al req.user})\n  // La funcion done crea el req.user \n   return done(null , {id: user._id , userName: user.userName})\n})\n\n")),(0,t.kt)("h3",{id:"deserializeruser"},"deserializerUser()"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Verifica que la sesion sea correcta/valida para restablecer la sesion . "),(0,t.kt)("li",{parentName:"ul"},"Sirve Para mantener/actualizar la sesion cuando se actualiza el sitio web.")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"// Tiene un callback con los mismos parametros que serializeUser()\npassport.deserializeUser((user , done) => {\n  // done(mensaje , usuario)\n  // la funcion done vuelve a crear el req.user\n  //  1 alternativa\n  return  done(null , user)\n  // 2 alternativa\n  return  done(null , {id:id , userName: user})\n})\n\n")),(0,t.kt)("h3",{id:"logout"},"logout()"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Cierra/Destruye la sesion")),(0,t.kt)("h3",{id:"en-el-proyecto-2"},"En el proyecto"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"La configuraci\xf3n de passport se hace despu\xe9s de la configuraci\xf3n de session y flash , ya que este modulo  las utiliza (para gestionarlas)"))),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const session = require("express-session");\nconst flash = require("connect-flash");\nconst express = require("express");\nconst { create } = require("express-handlebars");\nconst passport = require("passport");\nconst User = require("./models/User");\nrequire(\'dotenv\').config()\nrequire(\'./database/conexion\');\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\nconst app = express();\n// Configuramos la sesion con el middleware.\napp.use(\n  session({\n      secret: \'palabra secreta\',\n      resave: false,\n      saveUninitialized: false,\n      name: "nombre de secreto"\n  })\n);\n// Configuramos flash con el middleware\napp.use(flash());\n// Configuramos passport con el middleware\napp.use(passport.initialize());\napp.use(passport.session());\n\n// Recibe un callback con dos parametros \n// user = el usuario que le vamos a enviar \n// done = Para decirle que se hizo con exito\npassport.serializeUser((user , done) => {\n  // done (errores , {los datos que van al req.user})\n  // La funcion done crea el req.user \n   return done(null , {id: user._id , userName: user.userName})\n})\n\n// Tiene un callback con los mismos parametros que serializeUser()\npassport.deserializeUser(async (user , done) => {\n  // done(mensaje , usuario)\n  // la funcion done vuelve a crear el req.user\n\n const userDB = await User.findById(user.id);\n  return  done(null , {id:userDB._id , userName: userDB.userName})\n})\n\napp.use(express.urlencoded({extended:true}))\napp.engine(".hbs", hbs.engine);\napp.set("view engine", ".hbs");\napp.set("views", "./views");\napp.use(express.static(__dirname + "/public"));\napp.use("/" , require(\'./routes/home\'));\napp.use("/auth" , require(\'./routes/auth\'));\nconst PORT = process.env.PORT || 5000;\napp.listen(PORT, () => console.log("server andando \ud83d\udd25 http://localhost:5000"));\n\n')),(0,t.kt)("h2",{id:"middleware-para-verificar-sesion"},"Middleware para verificar sesion"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Tenemos que crear un middleware que verifique que el usuario tenga una sesion activa")),(0,t.kt)("p",null,"creamos el archivo verificarUser.js dentro de la carpeta middlewares"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"module.exports = (req , res , next) => {\n  // El req ya va a tener todas las configuraciones de passport\n   // isAuthenticated() es un metodo de  passport\n    if (req.isAuthenticated()) {\n        // Si el usuario tiene una  sesion  activa que pase al siguiente middleware o que pase al servidor para poder gestionar la peticion.\n        return next();\n    }\n    // Si no tiene una sesion activa\n    res.redirect('/auth/login');\n}\n\n")),(0,t.kt)("p",null,"routes/home.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const verificarUser = require('../middlewares/verificarUser');\nrouter.get(\"/\" , verificarUser,  leerUrls)\n\n")),(0,t.kt)("p",null,"authController.js"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Usamos el m\xe9todo login de Passport para crear la sesion de usuario")))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const loginUser = async (req,res) => {\n  const errors = validationResult(req);\n  if (!errors.isEmpty()) {\n    req.flash(\"mensajes\" , errors.array());\n    return res.redirect('/auth/login')\n  }\n  const {email,password} = req.body;\n  try {\n      const user = await User.findOne({email})\n      if (!user) throw new Error('No existe este email');\n      if (!user.cuentaConfirmada) throw new Error('Falta confirmar cuenta');\n      if (!await user.comparePassword(password)) throw new Error('Contrase\xf1a no correcta');\n      //login(usuario , callback)\n      // Con el parametro del callback gestiona los errores(seria como el catch)\n     req.login(user , function(error)  {\n              // Si hay errores \n              if (error) throw new Error('Error al crear la sesion')\n               // Si no hay errores\n               res.redirect('/');\n     })\n\n  } catch(error) {\n    req.flash(\"mensajes\" , [{msg: error.message}]);\n    return res.redirect('/auth/login')\n  }\n}\n\n")),(0,t.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"warning")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Como la sesion esta en memoria (en la maquina), al reiniciar el servidor se pierde todo."))),(0,t.kt)("h2",{id:"cerrar-sesion"},"Cerrar sesion"),(0,t.kt)("p",null,"routes/auth.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const { loginForm, registerForm, registerUser, confirmarCuenta , loginUser, cerrarSesion } = require('../controllers/authController');\nrouter.get(\"/logout\" , cerrarSesion)\nmodule.exports = router;\n\n")),(0,t.kt)("p",null,"authController.js"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Usaremos el m\xe9todo logout que viene del Passport"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const cerrarSesion = (req,res) => {\n  //el metodo logout de passport\n  // logout() = cierra la sesion\n  req.logout();\n  return res.redirect('/auth/login')\n}\nmodule.exports = {\n    loginForm , registerForm , registerUser , confirmarCuenta , loginUser , cerrarSesion\n}\n\n")),(0,t.kt)("h2",{id:"csrf-protection-middleware"},"CSRF protection middleware"),(0,t.kt)("p",null,"Sirve para:"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Comprobar que los formularios sean definitivamente de nuestra web y no de un tercero."),(0,t.kt)("li",{parentName:"ul"},"Comprobar que los formularios son enviados desde nuestro sitio."),(0,t.kt)("li",{parentName:"ul"},"Para dicho objetivo usamos el modulo ",(0,t.kt)("a",{parentName:"li",href:"https://github.com/expressjs/csurf"},"csurf"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm install csurf\n")),(0,t.kt)("p",null,"Lo configuramos y lo llamamos en el proyecto"),(0,t.kt)("p",null,"index.js"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Objetivo ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Habilitar Las protecciones (Validaciones)"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const session = require("express-session");\nconst flash = require("connect-flash");\nconst express = require("express");\nconst { create } = require("express-handlebars");\nconst passport = require("passport");\nconst User = require("./models/User");\nrequire(\'dotenv\').config()\nrequire(\'./database/conexion\');\nconst csrf = require("csurf");\n//  configuramos csrf con el middleware \napp.use(csrf());\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Se recomienda reiniciar el servidor (bajar nodemon y volver a levantarlo)"))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Resultado")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Te tirara error en el home."),(0,t.kt)("p",{parentName:"div"},"Eso sucede porque no especificamos que el formulario proviene de nuestro sitio y por lo tanto es seguro."))),(0,t.kt)("p",null,"Para especificar que los formularios provienen de nuestro sitio, tenemos que enviarle un token a los formulario."),(0,t.kt)("p",null,"Para enviar dicho token , vamos a usar un input de tipo hidden en todos los formularios"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"warning")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"el name del input no se puede modificar"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-html"},'\n<input type="hidden" name="_csrf" value="{{csrfToken}}" />\n\n')),(0,t.kt)("p",null,"En views/components/Form.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'{{#if url}}\n    <form action="/editar/{{url._id}}" method="post">\n    <input type="hidden" name="_csrf" value="{{csrfToken}}" />\n<input  value="{{url.origin}}" type="text" placeholder="Ingrese URL" name="origin" class="form-control my-2">\n <button type="submit" class="btn btn-warning w-100 mb-2">Editar</button>\n</form>\n{{else}}\n<form action="/" method="post">\n<input type="hidden" name="_csrf" value="{{csrfToken}}" />\n<input type="text" placeholder="Ingrese URL" name="origin" class="form-control my-2">\n <button type="submit" class="btn btn-primary w-100 mb-2">Agregar Url</button>\n</form>\n\n{{/if}}\n\n')),(0,t.kt)("p",null,"views/login.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'\n<h1 class="text-center my-5">Login de usuarios</h1>\n<div class="row justify-content-center">\n    <div class="col-md-6">\n        <form action="/auth/login" method="post">\n          <input type="hidden" name="_csrf" value="{{csrfToken}}" />\n            <input type="text" placeholder="Ingrese email" name="email" class="form-control mb-2"\n                value="usuario@test.com">\n            <input type="password" placeholder="Ingrese password" name="password" class="form-control mb-2"\n                value="123123">\n           \n            <button class="btn btn-primary" type="submit">Acceder</button>\n        </form>\n    </div>\n</div>\n\n\n')),(0,t.kt)("p",null,"y asi con todas las vistas que tengan formularios"),(0,t.kt)("h3",{id:"ahora-vamos-a-mandarle-ese-dato-a-la-vista-cuando-renderizamos"},"Ahora vamos a mandarle ese dato a la vista cuando renderizamos"),(0,t.kt)("p",null,"authController.js"),(0,t.kt)("h4",{id:"de-forma-manual"},"De forma manual:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const registerForm = (req,res) => {\n      res.render('register' , {mensajes : req.flash(\"mensajes\") , csrfToken:req.csrfToken()})\n}\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"el m\xe9todo  csrfToken() lo genera csurf cuando lo configuramos con el middleware."))),(0,t.kt)("h4",{id:"de-forma-global-a-trav\xe9s-de-un-middleware"},"De forma global a trav\xe9s de un middleware"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"No se necesita enviarlo en cada ruta como la forma manual.")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"app.use(express.urlencoded({extended:true}));\napp.use(csrf());\n\n// variables globales para las vistas\n// Enviamos una llave a todas las p\xe1ginas que renderizamos \n  // res.locals.nombrellave = valor;\n\napp.use((req, res, next) => {\n    res.locals.csrfToken = req.csrfToken();\n    next();\n});\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Se envia a todas las vistas a traves del middleware."),(0,t.kt)("li",{parentName:"ul"},"El token se debe enviar despu\xe9s de configurar el body de un formulario (app.use(express.urlencoded({extended:true}))) ya que se envia por POST")))),(0,t.kt)("h2",{id:"variables-globales"},"Variables globales"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Sirven para enviar datos a todas las vistas a trav\xe9s de un middleware."),(0,t.kt)("li",{parentName:"ul"},"Hacemos m\xe1s variables globales\nauthController.js")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const loginForm = (req,res) => {\n       res.render('login' )\n}\nconst registerForm = (req,res) => {\n      res.render('register' )\n}\n\n")),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'// variables globales para las vistas\n// Enviamos dos llave a todas las paginas que renderizamos \n  // res.locals.nombrellave = valor;\n\napp.use((req, res, next) => {\n    res.locals.csrfToken = req.csrfToken();\n    res.locals.mensajes = req.flash("mensajes");\n    next();\n});\n\n')),(0,t.kt)("h2",{id:"cambios-en-el-proyecto"},"Cambios en el proyecto"),(0,t.kt)("h3",{id:"verificamos-la-sesion-en-las-rutas-de-home"},"Verificamos la sesion en las rutas de home"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Podemos poner varios middleware en una ruta"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const express = require(\'express\');\nconst router = express.Router();\nconst {leerUrls , agregarUrl , eliminarUrl , editarUrlForm , editarUrl , redireccionamiento} = require(\'../controllers/homeController\' )\nconst urlValida = require(\'../middlewares/urlValida\');\nconst verificarUser = require(\'../middlewares/verificarUser\');\nrouter.get("/" , verificarUser,  leerUrls)\nrouter.post("/" , verificarUser , urlValida ,  agregarUrl)\nrouter.get("/eliminar/:id"  , verificarUser , eliminarUrl);\nrouter.get("/editar/:id", verificarUser ,editarUrlForm);\nrouter.post("/editar/:id" , verificarUser , urlValida ,  editarUrl)\nrouter.get("/:url"  , redireccionamiento)\nmodule.exports = router;\n\n')),(0,t.kt)("h3",{id:"ponemos-mensajes-flash-que-se-puedan-ver-en-la-vista-sobre-las-validaciones-de-la-url"},"Ponemos mensajes flash que se puedan ver en la vista sobre las validaciones de la url"),(0,t.kt)("p",null,"middlewares/urlValida.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'// Modulo que viene incorporado con Node.js\nconst { URL } = require("url");\nconst urlValidar = (req,res , next) => {\n // Si todo esta correcto llamamos a next\n // next = eliminarUrl\n    try {\n        // Leo el body del formulario\n        const { origin } = req.body;\n        // Se crea una nueva instancia de URL con la informacion del formulario\n        const urlFrontend = new URL(origin);\n        //La instancia(objeto) tiene la propiedad origin\n        //Si es distinto a null , tiene el formato de url\n        if (urlFrontend.origin !== "null") {\n            // Comprueba que tenga el protocolo http o https y si lo tiene llama al next()\n            if (\n                urlFrontend.protocol === "http:" ||\n                urlFrontend.protocol === "https:"\n            ) {\n                return next();\n            }\n            throw new Error("Tiene que tener https://");\n        }\n        // Lanzamos un error en caso que no sea valida\n        throw new Error("no v\xe1lida \ud83d\ude32");\n    } catch (error) {\n        console.log("Invalid URL:"+req.body.origin);\n        if (error.message === "Invalid URL: "+req.body.origin) {\n            req.flash("mensajes", [{ msg: "URL no v\xe1lida" }]);\n        } else {\n            req.flash("mensajes", [{ msg: error.message }]);\n        }\n       \n        \n    return res.redirect(\'/\')\n    }\n};\n\nmodule.exports = urlValidar;\n\n')),(0,t.kt)("h2",{id:"ref-mongodb"},"ref mongoDB"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"En mongoDB Podemos hacer una referencia (parecido a una relaci\xf3n)\nmodels/Url.js")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"\nconst mongoose = require('mongoose')\nconst {Schema} = mongoose\nconst urlSchema = new Schema({\n\n    origin: {\n        type: String,\n        unique: true,\n        required: true\n    },\n    shortURL: {\n        type: String,\n        unique: true,\n        required: true,\n    } ,\n    // Referencia a un usuario \n    user: {\n        // Schema.Types.ObjectId  =   De tipo ID de un documento de una coleccion.\n         type: Schema.Types.ObjectId,\n         // ref: nombre de la coleccion(nombre del modelo) al que hace referencia\n         ref:\"User\" ,\n         required:true,\n    }\n})\n\nconst Url = mongoose.model('Url', urlSchema)\nmodule.exports = Url;\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Explicacion como si fuera relacional")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Se hace una referencia a la columna _id(type:Schema.Types.ObjectId) de la tabla User(ref:\u201dUser\u201d)."),(0,t.kt)("li",{parentName:"ul"},"_id lo genera mongoDB de manera autom\xe1tica.")))),(0,t.kt)("p",null,"HomeController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'// Importamos el modelo\nconst Url = require(\'../models/Url\');\nconst {nanoid} = require(\'nanoid\');\n\nconst leerUrls = async(req,res) => {\n   try {\n       // req.user es la informacion del usuario que se encuentra en la sesion\n     // Buscamos todas las url donde user = req.user.id\n      const urls = await Url.find({user:req.user.id}).lean();\n      res.render(\'home\' , {urls:urls })\n   } catch (e) {\n    req.flash("mensajes" , [{msg: error.message}]);\n    return res.redirect(\'/\')\n   }\n\n    }\nconst agregarUrl = async(req,res) => {\n    const {origin} = req.body;\n    try {\n        // Generamos una nueva instancia del modelo con la id del usuario\n       const url = new Url({origin:origin , shortURL:nanoid(6) , user: req.user.id})\n       await url.save();\n       req.flash("mensajes" , [{msg:"URL AGREGADA"}])\n       res.redirect(\'/\');\n    } catch(error) {\n        req.flash("mensajes" , [{msg: error.message}]);\n        return res.redirect(\'/\')\n    }\n}\nconst eliminarUrl = async(req,res) => {\n    \n    const {id} = req.params;\n    try {\n        // Buscamos la url por la id\n       const url = await Url.findById(id);\n       // Si la url no pertenece al usuario\n       if (!url.user.equals(req.user.id)) {\n         throw new Error("No es tu url ");\n       }\n       // Lo eliminamos  de la BD con el metodo remove() que viene del objeto MongoDB\n       await url.remove();\n       req.flash("mensajes" , [{msg:"URL ELIMINADA"}])\n       res.redirect(\'/\');\n     } catch(error) {\n        req.flash("mensajes" , [{msg: error.message}]);\n        return res.redirect(\'/\')\n     }\n}\n\nconst editarUrlForm = async(req,res) => {\n    \n    const {id} = req.params;\n    try {\n      \n       const url = await Url.findById(id).lean()\n       if (!url.user.equals(req.user.id)) {\n        throw new Error("No es tu url ");\n      }\n      \n       res.render(\'home\',{url})\n    } catch(error) {\n        req.flash("mensajes" , [{msg: error.message}]);\n        return res.redirect(\'/\')\n    }\n}\nconst editarUrl = async(req,res) => {\n  \n    const {id} = req.params;\n    const {origin} = req.body;\n    try {\n       // Buscamos la url por la id\n       const url = await Url.findById(id);\n       // Si la url no pertenece al usuario\n       if (!url.user.equals(req.user.id)) {\n         throw new Error("No es tu url ");\n       }\n       // Lo actualizamos  en la BD con el metodo updateOne() que viene del objeto MongoDB\n       //recibe un objeto{} con los datos que se van a editar\n       //origin:origin\n       await url.updateOne({origin});\n       req.flash("mensajes" , [{msg:"URL EDITADA"}])\n       res.redirect(\'/\');\n    \n    } catch(error) {\n        req.flash("mensajes" , [{msg: error.message}]);\n        return res.redirect(\'/\')\n    }\n}\n\nconst redireccionamiento = async(req,res) => {\n    const {url} = req.params\n    try {\n       // Modificar en la documentacion\n       const urlDB = await Url.findOne({shortURL: url })\n       res.redirect(urlDB.origin);\n    } catch(error) {\n        req.flash("mensajes" , [{msg: "No existe esta url configurada"}]);\n        return res.redirect(\'/auth/login\')\n    }\n}\n   module.exports = {leerUrls , agregarUrl , eliminarUrl , editarUrlForm , editarUrl , redireccionamiento};\n\n')),(0,t.kt)("h2",{id:"nodemailer"},"Nodemailer"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Es un ",(0,t.kt)("a",{parentName:"li",href:"https://nodemailer.com/about/"},"m\xf3dulo")," para enviar correos electr\xf3nicos"),(0,t.kt)("li",{parentName:"ul"},"Para usarlo ,  se debe configurar un hosting (Gmail, servidor, etc) para   que acepte el env\xedo de informaci\xf3n."),(0,t.kt)("li",{parentName:"ul"},"Para simular un hosting usaremos ",(0,t.kt)("a",{parentName:"li",href:"https://mailtrap.io"},"mailtrap")," que prueba los correo electronicos y simula que los esta enviando. Tambien nos permite ver los correos enviados.")),(0,t.kt)("h3",{id:"guia-de-mailtrap"},"Guia de mailtrap"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"Nos registramos"),(0,t.kt)("li",{parentName:"ol"},"En integraciones nos aparece NodeMailer"),(0,t.kt)("li",{parentName:"ol"},"AL SELECCIONARLO ,NOS APARECE LA CONFIGURACION para crear el transportador")),(0,t.kt)("p",null,"Algo asi:"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'var transport = nodemailer.createTransport({\n  host: "smtp.mailtrap.io",\n  port: 2525,\n  auth: {\n    user: "815fddfe9d615f",\n    pass: "8a37d820c188a6"\n  }\n});\n\n')),(0,t.kt)("ol",{start:4},(0,t.kt)("li",{parentName:"ol"},"Lo de la autenticaci\xf3n lo vamos a tener que pasar a un archivo .env ya que es informaci\xf3n sensible")),(0,t.kt)("h3",{id:"guia--de-nodemailer"},"Guia  de NodeMailer"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"Se importa"),(0,t.kt)("li",{parentName:"ol"},"Se crea un transportador con las configuraciones del hosting"),(0,t.kt)("li",{parentName:"ol"},"Se envia el correo")),(0,t.kt)("h3",{id:"en-el-proyecto-3"},"En el proyecto"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm install nodemailer\n")),(0,t.kt)("p",null,"AuthController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const nodemailer = require("nodemailer");\nrequire(\'dotenv\').config()\nconst registerUser = async (req,res) => {\n  \n  const errors = validationResult(req);\n\n  if (!errors.isEmpty()) {\n    req.flash("mensajes" , errors.array());\n    return res.redirect(\'/auth/register\')\n  }\n    const {userName , email , password} = req.body\n    try {\n        \n       let user = await User.findOne({email:email});\n      \n       if (user) throw new Error(\'ya existe el usuario\');\n     \n      user = new User({userName , email , password  , tokenConfirm: nanoid()});\n      user.save()\n      // Creamos el transportador\n      const transporte = nodemailer.createTransport({\n        host: "smtp.mailtrap.io",\n        port: 2525,\n        auth: {\n          user: process.env.userEmail,\n          pass: process.env.userPassword\n        }\n      });\n      // Enviamos el correo \n      let info = await transporte.sendMail({\n        // Quien lo envia\n        from: \'"Fred Foo \ud83d\udc7b" <foo@example.com>\', \n        // A quien se envia\n        to: user.email, \n        // Asunto\n        subject: "Verifica tu cuenta de correo",\n        //texto plano  \n        //text: "Hello world?",\n        //texto en HTML\n        html: `<a href="http://localhost:5000/auth/confirmarCuenta/${user.tokenConfirm}">Verifica tu cuenta aqui</a>`, \n      });\n      req.flash("mensajes" , [{msg: "Revisa tu correo electronico y valida cuenta"}]);\n      res.redirect(\'/auth/login\');\n    } catch(error) {\n      req.flash("mensajes" , [{msg: error.message}]);\n      return res.redirect(\'/auth/register\')\n    }\n}\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"el require('dotenv').config() se ubica en todos los archivos que utiliza variables de entorno"))),(0,t.kt)("p",null,".env"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"URI=mongodb+srv://User_API:contrase\xf1a@cluster.xcibc.mongodb.net/dbUrl?retryWrites=true&w=majority\nuserEmail=815fddfe9d615f\nuserPassword=8a37d820c188a6\n\n")),(0,t.kt)("h2",{id:"subir-archivos"},"Subir archivos"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},(0,t.kt)("a",{parentName:"p",href:"https://picsum.photos"},"Pagina para generar imagen aleatoria"))),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Las imagenes las guardamos en la carpeta publica (En este ejemplo public/img/perfiles)")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"El modulo ",(0,t.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/multer"},"multer")," o el modulo ",(0,t.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/formidable"},"formidable")," contiene la logica para manipular las imagenes ")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"En el ejemplo se utiliza formidable")),(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Tambi\xe9n usaremos el m\xf3dulo ",(0,t.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/jimp"},"jimp"),"   para editar la imagen (redimensionar , quitar calidad , etc)\nModels/User"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const UserSchema = new Schema({\n  \n   userName: {\n       type:String,\n       lowercase:true,\n       required:true,\n   } ,\n\n   email: {\n    type:String,\n    lowercase:true,\n    required:true ,\n    unique : true ,\n    // Indexar\n    index: {unique : true} , \n} ,\n\npassword: {\n    type:String ,\n    required : true ,\n\n} ,\n\ntokenConfirm : {\n    type:String ,\n    default:null,\n} ,\n\ncuentaConfirmada: {\n    type:Boolean,\n    default:false\n} , \nimagen: {\n    type:String ,\n    default: null,\n}\n\n})\n\n")),(0,t.kt)("p",null,"views/perfil.hbs"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-hbs"},'\n<h1 class="text-center">Nombre del usuario</h1>\n<p class="text-center">Edita aqui tu perfil</p>\n<div class="my-2 text-center">\n    <img src="/img/perfiles/imagen.jpg" alt="" class="rounded-circle">\n</div>\n<form action="/perfil?_csrf={{csrfToken}}" method="post" enctype="multipart/form-data">\n <input class="form-control mb-2 form-control-sm" type="file" id="formFile" name="myFile" />\n <button class="btn btn-dark my-3">Cambiar imagen de perfil</button>\n</form>\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},'Usa(atributo-valor)  enctype="multipart/form-data" en el formulario para enviar im\xe1genes.'),(0,t.kt)("li",{parentName:"ul"},"Usar el atributo multiple en el input file si desea subir varios archivos."),(0,t.kt)("li",{parentName:"ul"},"Para los formularios que contienen im\xe1genes, el token de csurf debe enviarse como query(a trav\xe9s de la url) ")),(0,t.kt)("pre",{parentName:"div"},(0,t.kt)("code",{parentName:"pre",className:"language-html"},'action="/perfil?_csrf={{csrfToken}}"\n')))),(0,t.kt)("p",null,"Creamos un archivo perfilController.js dentro de la carpeta controllers."),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Otra forma de exportar"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'//module.exports.nombrefuncion = funcion\n// se exporta el nombrefuncion \nmodule.exports.formPerfil = async(req,res) => {\n   res.render("perfil");\n} \nmodule.exports.editarFotoPerfil = async(req,res) => {\n   \n} \n\n')),(0,t.kt)("p",null,"routes/home.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const { formPerfil, editarFotoPerfil } = require(\'../controllers/perfilController\');\nrouter.get("/perfil" , verificarUser , formPerfil);\nrouter.post("/perfil" , verificarUser , editarFotoPerfil);\n\n')),(0,t.kt)("p",null,"views/components/Navbar.hbs"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"A\xf1adimos la ruta en el men\xfa")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-html"},'  <div class="navbar-nav ms-auto">\n        <a class="nav-link active" aria-current="page" href="/">Home</a>\n        <a class="nav-link" href="/auth/register">Register</a>\n        <a class="nav-link" href="/perfil">Perfil</a>\n        <a class="nav-link" href="/auth/login">Login</a>\n        <a class="nav-link" href="/auth/logout">LogOut</a>\n      </div>\n\n')),(0,t.kt)("h2",{id:"formidable"},"Formidable"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i formidable\n")),(0,t.kt)("h3",{id:"peque\xf1o-tutorial"},"Peque\xf1o tutorial"),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},"Se crea una instancia ",(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const form = formidable({ multiples: true });\n")))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"multiples = boolean Sirve para especificar si son varias im\xe1genes")))),(0,t.kt)("ol",{start:2},(0,t.kt)("li",{parentName:"ol"},"Usamos el metodo parse() de la instancia para leer y procesar la imagen ")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"A trav\xe9s de files (par\xe1metro del callback de la funci\xf3n parse()), tenemos toda la informaci\xf3n de la imagen (extensi\xf3n , tama\xf1o ,etc). Toda esa informaci\xf3n viene de una propiedad que se llama igual que el valor del atributo name del input file")),(0,t.kt)("p",null,"perfilController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const formidable = require(\'formidable\');\n//module.exports.nombrefuncion = funcion\n// se exporta el nombrefuncion \nmodule.exports.formPerfil = async(req,res) => {\n   res.render("perfil");\n} \nmodule.exports.editarFotoPerfil = async(req,res) => {\n   // Instanciamos un objeto formidable\n   const form = new formidable.IncomingForm()\n   // Especificamos el tama\xf1o  maximo del archivo\n   // 50 * 1024 * 1024 = 5MB \n   form.maxFileSize = 50 * 1024 * 1024\n   //parse(de donde viene la imagen , funcion)\n   form.parse(req , async(err, fields , files) => {\n      try {\n         // Si tiene un error\n      if (err) {\n         throw new Error(\'No es una imagen\');\n      }\n      //Contiene toda la informacion de la imagen\n      // La propiedad myFile se llama igual que el valor del atributo name del input file \n      // Por lo tanto el nombre de la propiedad cambia , si el valor del atributo name cambia\n      const file = files.myFile;\n      // Validaciones\n      // Comprobar que existe una imagen\n      if(file.originalFilename === "" ) {\n         throw new Error(\'Por favor agrega una imagen\');\n      }\n      // Validamos el formato de la imagen\n     if (!(file.mimetype == "image/jpeg" || file.mimetype == "image/png")) {\n      throw new Error(\'Por favor agrega una imagen .pjg o .png\');\n     }\n      // Validamos el tama\xf1o  (que sea menor a 5mb)\n      console.log(file);\n      if (file.size > 5 * 1024 * 1024) {\n         throw new Error(\'Menos de 5mb \');\n      }\n      // Sacamos la extension\n      const extension = file.mimetype.split("/")[1];\n      // Donde se va a guardar la imagen \n      const dirFile = __dirname + "../public/perfiles/"\n       req.flash("mensajes" , [{msg: "Ya se subio la imagen"}]);\n      return res.redirect(\'/perfil\');\n   } catch (error) {\n        \n        req.flash("mensajes" , [{msg: error.message}]);\n        return res.redirect(\'/perfil\')\n   }\n   })\n} \n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"__dirname  ")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"devuelve la Ubicaci\xf3n del archivo"))),(0,t.kt)("h2",{id:"modulo-nativo-path-join"},"Modulo nativo Path (Join)"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Tiene el m\xe9todo join que nos permite formar una ruta"),(0,t.kt)("li",{parentName:"ul"},"Tambi\xe9n nos permite usar los \u201cpuntos\u201d para la ubicaci\xf3n de archivos (../.)")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const path  = require('path');\n // Donde se va a guardar la imagen \n// __dirname/../public/perfiles/id.extension\n const dirFile = path.join(__dirname , `../public/img/perfiles/${req.user.id}.${extension}`);\n\n")),(0,t.kt)("h2",{id:"file-system"},"file System"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Ahora vamos a usar el modulo file System para guardar el archivo."),(0,t.kt)("li",{parentName:"ul"},"Sirve para manipular los archivos")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const fs = require(\'fs\');\n// Sacamos la extension\n      const extension = file.mimetype.split("/")[1];\n      // Donde se va a guardar la imagen \n      const dirFile = path.join(__dirname , `../public/img/perfiles/${req.user.id}.${extension}`);\n      // Guardamos la imagen  con el metodo renameSync\n      // renameSync(ruta_vieja , ruta_mueva)\n      // la propiedad filepath contiene la ubicacion del archivo\n       fs.renameSync(file.filepath , dirFile );\n       req.flash("mensajes" , [{msg: "Ya se subio la imagen"}]);\n\n')),(0,t.kt)("p",null,"Completo: "),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const formidable = require('formidable');\nconst path  = require('path');\nconst fs = require('fs');\nmodule.exports.formPerfil = async(req,res) => {\n   res.render(\"perfil\");\n} \nmodule.exports.editarFotoPerfil = async(req,res) => {\n   // Instanciamos un objeto formidable\n   const form = new formidable.IncomingForm()\n   // Especificamos el tama\xf1o  maximo del archivo\n   // 50 * 1024 * 1024 = 5MB \n   form.maxFileSize = 50 * 1024 * 1024\n   //parse(de donde viene la imagen , funcion)\n   form.parse(req , async(err, fields , files) => {\n      try {\n         // Si tiene un error\n      if (err) {\n         throw new Error('No es una imagen');\n      }\n      //Contiene toda la informacion de la imagen\n      // La propiedad myFile se llama igual que el valor del atributo name del input file \n      // Por lo tanto el nombre de la propiedad cambia , si el valor del atributo name cambia\n      const file = files.myFile;\n      // Validaciones\n      // Comprobar que existe una imagen\n      if(file.originalFilename === \"\" ) {\n         throw new Error('Por favor agrega una imagen');\n      }\n      // Validamos el formato de la imagen\n     if (!(file.mimetype == \"image/jpeg\" || file.mimetype == \"image/png\")) {\n      throw new Error('Por favor agrega una imagen .pjg o .png');\n     }\n      // Validamos el tama\xf1o  (que sea menor a 5mb)\n      console.log(file);\n      if (file.size > 5 * 1024 * 1024) {\n         throw new Error('Menos de 5mb ');\n      }\n      // Sacamos la extension\n      const extension = file.mimetype.split(\"/\")[1];\n      // Donde se va a guardar la imagen \n      const dirFile = path.join(__dirname , `../public/img/perfiles/${req.user.id}.${extension}`);\n      // Guardamos la imagen  con el metodo renameSync\n      // renameSync(ruta_vieja , ruta_mueva)\n      // la propiedad filepath contiene la ubicacion del archivo\n       fs.renameSync(file.filepath , dirFile );\n       req.flash(\"mensajes\" , [{msg: \"Ya se subio la imagen\"}]);\n      return res.redirect('/perfil');\n   } catch (error) {\n        \n        req.flash(\"mensajes\" , [{msg: error.message}]);\n        return res.redirect('/perfil')\n   }\n   })\n} \n\n")),(0,t.kt)("h3",{id:"a-guardar-en-la-bd-la-url-de-la-imagen"},"A guardar en la BD la url de la imagen"),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"el m\xe9todo save() viene de un objeto mongoDB que nos permite guardar en la BD el objeto."))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const formidable = require('formidable');\nconst path  = require('path');\nconst fs = require('fs');\nconst User = require('../models/User');\nmodule.exports.formPerfil = async(req,res) => {\n   res.render(\"perfil\");\n} \nmodule.exports.editarFotoPerfil = async(req,res) => {\n   // Instanciamos un objeto formidable\n   const form = new formidable.IncomingForm()\n   // Especificamos el tama\xf1o  maximo del archivo\n   // 50 * 1024 * 1024 = 5MB \n   form.maxFileSize = 50 * 1024 * 1024\n   //parse(de donde viene la imagen , funcion)\n   form.parse(req , async(err, fields , files) => {\n      try {\n         // Si tiene un error\n      if (err) {\n         throw new Error('No es una imagen');\n      }\n      //Contiene toda la informacion de la imagen\n      // La propiedad myFile se llama igual que el valor del atributo name del input file \n      // Por lo tanto el nombre de la propiedad cambia , si el valor del atributo name cambia\n      const file = files.myFile;\n      // Validaciones\n      // Comprobar que existe una imagen\n      if(file.originalFilename === \"\" ) {\n         throw new Error('Por favor agrega una imagen');\n      }\n      // Validamos el formato de la imagen\n     if (!(file.mimetype == \"image/jpeg\" || file.mimetype == \"image/png\")) {\n      throw new Error('Por favor agrega una imagen .pjg o .png');\n     }\n      // Validamos el tama\xf1o  (que sea menor a 5mb)\n      console.log(file);\n      if (file.size > 5 * 1024 * 1024) {\n         throw new Error('Menos de 5mb ');\n      }\n      // Sacamos la extension\n      const extension = file.mimetype.split(\"/\")[1];\n      // Donde se va a guardar la imagen \n      const dirFile = path.join(__dirname , `../public/img/perfiles/${req.user.id}.${extension}`);\n      // Guardamos la imagen  con el metodo renameSync\n      // renameSync(ruta_vieja , ruta_mueva)\n      // la propiedad filepath contiene la ubicacion del archivo\n       fs.renameSync(file.filepath , dirFile );\n       // La guardamos en la BD\n       const user = await User.findById(req.user.id);\n       user.imagen = `${req.user.id}.${extension}`;\n       await user.save();\n       req.flash(\"mensajes\" , [{msg: \"Ya se subio la imagen\"}]);\n      return res.redirect('/perfil');\n   } catch (error) {\n        \n        req.flash(\"mensajes\" , [{msg: error.message}]);\n        return res.redirect('/perfil')\n   }\n   })\n} \n\n")),(0,t.kt)("h2",{id:"jimp"},"jimp"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Usamos el modulo jimp para modificar la imagen"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i jimp\n")),(0,t.kt)("p",{parentName:"li"}," Despues de guardar la imagen:"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},"fs.renameSync(file.filepath , dirFile );\n      // Leemos la imagen (creamos una  instancia)\n     const image =  await Jimp.read(dirFile);\n     // Cambiamos el tama\xf1o  (resize)\n     // Cambiamos la calidad (quality)\n     // Lo volvemos a guardar (writeAsync)\n      image.resize(200,200).quality(90).writeAsync(dirFile);\n      const user = await User.findById(req.user.id);\n\n")),(0,t.kt)("h3",{parentName:"li",id:"lo-mostramos-en-la-ruta"},"Lo mostramos en la ruta:"),(0,t.kt)("p",{parentName:"li"}," perfileController.js"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},'module.exports.formPerfil = async(req,res) => {\n  \n  try {\n        const user = await User.findById(req.user.id);\n        res.render("perfil" , {user: req.user , imagen: user.imagen});\n  } catch(error) {\n     req.flash("mensajes" , [{msg: "Error al leer el usuario"}]);\n     return res.redirect(\'/perfil\')\n  }\n} \n')),(0,t.kt)("p",{parentName:"li"},"  views/perfi.hbs"))),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},' <h1 class="text-center">{{user.userName}}</h1>\n<p class="text-center">Edita aqui tu perfil</p>\n<div class="my-2 text-center">\n    {{#if imagen}}\n         <img src="/img/perfiles/{{imagen}}" alt="" class="rounded-circle">\n         {{else}} \n              <img src="/img/perfiles/imagen.jpg" alt="" class="rounded-circle">\n    {{/if}}\n   \n</div>\n<form action="/perfil?_csrf={{csrfToken}}" method="post" enctype="multipart/form-data">\n <input class="form-control mb-2 form-control-sm" type="file" id="formFile" name="myFile" />\n <button class="btn btn-dark my-3">Cambiar imagen de perfil</button>\n</form>\n\n')),(0,t.kt)("h2",{id:"connet-mongo"},"connet-mongo"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Las sesiones trabajan en memoria local (en el servidor/PC)"),(0,t.kt)("li",{parentName:"ul"},"Express recomienda que en producci\xf3n (deploy) no trabajemos con la sesion en memoria."),(0,t.kt)("li",{parentName:"ul"},"Usaremos el modulo connect-mongo para respaldar la sesion en la BD.")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i connect-mongo\n")),(0,t.kt)("p",null,"database/conexion.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"const mongoose = require('mongoose');\n// Habilitamos las variables de entorno\nrequire('dotenv').config()\n\nconst clientDB = mongoose.connect(process.env.URI).then((m)=> {\n\n    console.log(\"db conectada \ud83d\udd25\");\n    // Devolvemos el cliente por el cual nos conectamos a la BD\n    return m.connection.getClient();\n}).catch(e => console.log(\"Fallo la conexion\" + e));\n\nmodule.exports = clientDB;\n\n")),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const session = require("express-session");\nconst MongoStore = require("connect-mongo");\nconst flash = require("connect-flash");\nconst express = require("express");\nconst { create } = require("express-handlebars");\nconst passport = require("passport");\nconst User = require("./models/User");\nrequire(\'dotenv\').config()\nconst clientDB = require(\'./database/conexion\');\nconst csrf = require("csurf");\n\n\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\nconst app = express();\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Toda la ejecuci\xf3n de un c\xf3digo (conexi\xf3n a la BD y retornar algo) se fue a una constante."),(0,t.kt)("li",{parentName:"ul"},"Al usar el require() se ejecuta el codigo y lo que se devuelve lo contiene la variable clientDB.")))),(0,t.kt)("h3",{id:"configuramos-las-sesiones-para-que-se-respalden-en-la-bd"},"Configuramos las sesiones para que se respalden en la BD."),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'\nconst session = require("express-session");\nconst MongoStore = require("connect-mongo");\nconst flash = require("connect-flash");\nconst express = require("express");\nconst { create } = require("express-handlebars");\nconst passport = require("passport");\nconst User = require("./models/User");\nrequire(\'dotenv\').config()\nconst clientDB = require(\'./database/conexion\');\nconst csrf = require("csurf");\n\n\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\nconst app = express();\napp.use(\n  session({\n      secret: \'palabra secreta\',\n      resave: false,\n      saveUninitialized: false,\n      name: "nombre de secreto" ,\n      // create({configuraciones})\n      store : MongoStore.create({\n        // Conexion a la BD\n           clientPromise: clientDB ,\n        // Nombre de la BD\n        dbName :  \'dbUrl\'\n      }),\n  })\n);  \n\n')),(0,t.kt)("h2",{id:"saniteze-mongo"},"Saniteze mongo"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Es un middleware para evitar inyecciones(ataques) en la BD."),(0,t.kt)("li",{parentName:"ul"},"Existen dos modulos con la misma funcion :  ",(0,t.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/mongo-sanitize"},"mongo-sanitize")," o ",(0,t.kt)("a",{parentName:"li",href:"https://www.npmjs.com/package/express-mongo-sanitize"},"express-mongo-sanitize")),(0,t.kt)("li",{parentName:"ul"},"Utilizaremos el segundo")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm i express-mongo-sanitize\n")),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const session = require("express-session");\nconst mongoSanitize = require(\'express-mongo-sanitize\');\nconst MongoStore = require("connect-mongo");\nconst flash = require("connect-flash");\nconst express = require("express");\nconst { create } = require("express-handlebars");\nconst passport = require("passport");\nconst User = require("./models/User");\nrequire(\'dotenv\').config()\nconst clientDB = require(\'./database/conexion\');\nconst csrf = require("csurf");\n\n\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\nconst app = express();\napp.use(\n  session({\n      secret: \'palabra secreta\',\n      resave: false,\n      saveUninitialized: false,\n      name: "nombre de secreto" ,\n   \n      store : MongoStore.create({\n           clientPromise: clientDB ,\n        dbName :  \'dbUrl\'\n      }),\n  })\n);  \napp.use(flash());\napp.use(passport.initialize());\napp.use(passport.session());\npassport.serializeUser((user , done) => {\n   return done(null , {id: user._id , userName: user.userName})\n})\npassport.deserializeUser(async (user , done) => {\n const userDB = await User.findById(user.id);\n  return  done(null , {id:userDB._id , userName: userDB.userName})\n})\n\napp.use(express.urlencoded({extended:true}));\napp.use(csrf());\n\n// Utilizamos el middleware\napp.use(mongoSanitize());\n\napp.use((req, res, next) => {\n    res.locals.csrfToken = req.csrfToken();\n    res.locals.mensajes = req.flash("mensajes");\n    next();\n});\n\n')),(0,t.kt)("h2",{id:"cors"},"CORS"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"modulo ",(0,t.kt)("a",{parentName:"li",href:"https://expressjs.com/en/resources/middleware/cors.html"},"cors")),(0,t.kt)("li",{parentName:"ul"},"Sirve para especificar que dominios van a consumir esta aplicaci\xf3n/sitio web / etc.")),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-powershell"},"npm install cors\n")),(0,t.kt)("p",null,".env"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"URI=mongodb+srv://User_API:contrase\xf1a@cluster.xcibc.mongodb.net/dbUrl?retryWrites=true&w=majority\nuserEmail=815fddfe9d615f\nuserPassword=8a37d820c188a6\nPATHOSTING=\n\n")),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Podemos crear variables de entornos vacia (PATHOSTING)"))),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'const session = require("express-session");\nconst mongoSanitize = require(\'express-mongo-sanitize\');\nconst MongoStore = require("connect-mongo");\nconst flash = require("connect-flash");\nconst express = require("express");\nconst { create } = require("express-handlebars");\nconst passport = require("passport");\nconst User = require("./models/User");\nrequire(\'dotenv\').config()\nconst clientDB = require(\'./database/conexion\');\nconst csrf = require("csurf");\nconst cors = require("cors");\n\n\nconst hbs = create({\n    extname: ".hbs",\n    partialsDir: ["views/components"],\n});\nconst app = express();\n// Configuramos el cors\nconst corsOptions = {\n  credentials: true,\n  // Que persona(servicios) van a consumir esta app\n  // "*" = Todas las personas\n  // Si NO existe la variable de entorno , todas las persona pueden consumir esta app\n  origin: process.env.PATHOSTING || "*",\n  // Los metodos HTTP que utilizamos \n  methods: [\'GET\' , \'POST\']\n};\n// Usamos el cors con la configuracion que especificamos\napp.use(cors(corsOptions));\napp.use(\n  session({\n      secret: process.env.SECRETSESSION,\n      resave: false,\n      saveUninitialized: false,\n      name: "nombre de secreto" ,\n\n      store : MongoStore.create({\n \n           clientPromise: clientDB ,\n \n        dbName :  process.env.DBNAME\n      }),\n  })\n);  \napp.use(flash());\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("ul",{parentName:"div"},(0,t.kt)("li",{parentName:"ul"},"Un formulario HTML solo envia GET Y POST"),(0,t.kt)("li",{parentName:"ul"},"Con fetch y Axios (JS ) podemos establecer m\xe9todos PUT , DELETE , ETC.")))),(0,t.kt)("h2",{id:"modificaciones-para-el-deploy"},"Modificaciones para el deploy"),(0,t.kt)("p",null,".env"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"URI=mongodb+srv://User_API:contrase\xf1a@cluster.xcibc.mongodb.net/dbUrl?retryWrites=true&w=majority\nuserEmail=815fddfe9d615f\nuserPassword=8a37d820c188a6\nPATHOSTING=\nSECRETSESSION=815fddfe9d615f\n\n")),(0,t.kt)("p",null,"index.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"app.use(\n  session({\n      secret: process.env.SECRETSESSION,\n      resave: false,\n      saveUninitialized: false,\n      name: \"nombre de secreto\" ,\n\n      store : MongoStore.create({\n \n           clientPromise: clientDB ,\n \n        dbName :  'dbUrl'\n      }),\n  })\n);  \n\n")),(0,t.kt)("p",null,"authController.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},'// Enviamos el correo \n      let info = await transporte.sendMail({\n        // Quien lo envia\n        from: \'"Fred Foo \ud83d\udc7b" <foo@example.com>\', \n        // A quien se envia\n        to: user.email, \n        // Asunto\n        subject: "Verifica tu cuenta de correo",\n        //texto plano  \n        //text: "Hello world?",\n        //texto en HTML\n        html: `<a href="${ process.env.PATHOSTING || "http://localhost:5000"}/auth/confirmarCuenta/${user.tokenConfirm}">Verifica tu cuenta aqui</a>`, \n      });\n\n')),(0,t.kt)("p",null,"public/js/app.js"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"document.addEventListener('click' , e => {\n    \n    if (e.target.dataset.short) {\n        // El window es global , se puede omitir\n         const url = `${window.location.origin}/${e.target.dataset.short}`;\n\n")),(0,t.kt)("p",null,"package.json"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-json"},'  "scripts": {\n    "dev": "nodemon index.js",\n    "start": "node index.js"\n  },\n\n')),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"},"Script start = Es el que ejecuta heroku"))),(0,t.kt)("h2",{id:"cookies-segura"},"Cookies segura"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"Le da seguridad al servidor",(0,t.kt)("h3",{parentName:"li",id:"pasos"},"Pasos"))),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Borramos las sesiones en la BD")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Modificamos el index.js"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-js"},'app.use(cors(corsOptions));\n// Para que el secure : true funcione\napp.set("trust proxy", 1);\napp.use(\n session({\n     secret: process.env.SECRETSESSION,\n     resave: false,\n     saveUninitialized: false,\n     name: "nombre de secreto" ,\n\n     store : MongoStore.create({\n\n          clientPromise: clientDB ,\n\n       dbName :  process.env.DBNAME\n     }), \n     // Habilitamos las cookies seguras\n     // secure : true es para https\n     // secure : false es para http\n     // Si esta en produccion , habilitamos las cookies seguras\n     cookie: { secure: process.env.MODO === \'production\' ? true : false, maxAge: 30 * 24 * 60 * 60 * 1000 },\n })\n);  \n\n')))),(0,t.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"}," Especifica cuanto va a durar la sesion. En este ejemplo son 30 dias."))),(0,t.kt)("p",null," .env"),(0,t.kt)("pre",null,(0,t.kt)("code",{parentName:"pre",className:"language-js"},"URI=mongodb+srv://User_API:contrase\xf1a@cluster.xcibc.mongodb.net/dbUrl?retryWrites=true&w=majority\nuserEmail=815fddfe9d615f\nuserPassword=8a37d820c188a6\nPATHOSTING=\nSECRETSESSION=815fddfe9d615f\nDBNAME=dbUrl\nMODO=production\n")),(0,t.kt)("h2",{id:"heroku"},"Heroku"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("a",{parentName:"li",href:"https://www.heroku.com/pricing"},"Heroku"),(0,t.kt)("h3",{parentName:"li",id:"en-el-sitio"},"En el sitio"))),(0,t.kt)("ol",null,(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Te creas una cuenta")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"Creas tu primera App  (Deja todo por defecto)")),(0,t.kt)("li",{parentName:"ol"},(0,t.kt)("p",{parentName:"li"},"En la parte de deploy nos muestra varias formas de desplegar la aplicaci\xf3n. Podes elegir heroku git (tenes que instalar heroku CLI)  o github. Depende de la opcion , los siguientes pasos cambian(En este ejemplo se usara github)"),(0,t.kt)("h3",{parentName:"li",id:"en-el-proyecto-4"},"En el proyecto"))),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},(0,t.kt)("p",{parentName:"li"},"Hacemos todo el procedimiento para ponerlo en un repositorio de github"),(0,t.kt)("p",{parentName:"li"}," .gitignore"),(0,t.kt)("pre",{parentName:"li"},(0,t.kt)("code",{parentName:"pre",className:"language-gitignore"},".env\nnode_modules\n\n")),(0,t.kt)("div",{parentName:"li",className:"admonition admonition-tip alert alert--success"},(0,t.kt)("div",{parentName:"div",className:"admonition-heading"},(0,t.kt)("h5",{parentName:"div"},(0,t.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,t.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,t.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observacion")),(0,t.kt)("div",{parentName:"div",className:"admonition-content"},(0,t.kt)("p",{parentName:"div"}," Heroku Lee el package.json  y las instala"))))),(0,t.kt)("h3",{id:"en-el-sitio-1"},"En el sitio"),(0,t.kt)("ol",{start:4},(0,t.kt)("li",{parentName:"ol"},"Le damos a GitHub"),(0,t.kt)("li",{parentName:"ol"},"Connect To GitHub y lo autorizas."),(0,t.kt)("li",{parentName:"ol"},"Buscamos el repositorio y nos conectamos"),(0,t.kt)("li",{parentName:"ol"},"Seleccionamos la rama que se va a hacer el deplo Y Le das a Deploy Branch"),(0,t.kt)("li",{parentName:"ol"},"Configuramos las variables de entorno (en el apartado de setting - config Var)")),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"En ese apartado ponemos las variables de entorno."),(0,t.kt)("li",{parentName:"ul"},"Key (Nombre) -> Valor"),(0,t.kt)("li",{parentName:"ul"},"Por cada actualizacion en el repositorio , hacemos el el deploy branch (a menos que lo configures en automatico)")),(0,t.kt)("h2",{id:"consejos"},"Consejos"),(0,t.kt)("ul",null,(0,t.kt)("li",{parentName:"ul"},"\xa1Si esta undefined es porque no estas esperando el resultado de la base de dato! USA EL AWAIT"),(0,t.kt)("li",{parentName:"ul"},"En todas las operaciones con una BD usar el await"),(0,t.kt)("li",{parentName:"ul"},"Al usar el redirect comprueba en la url si te dirige hacia donde especificaste."),(0,t.kt)("li",{parentName:"ul"},"Cuidado con poner dos respuestas en un bloque , que genera errores."),(0,t.kt)("li",{parentName:"ul"},"En las validaciones no darle informaci\xf3n espec\xedfica  de que se equivoc\xf3 al cliente por tema de seguridad:\nEjemplo: Mal: Fallo el usuario  Correcto: Fallo el Usuario o la contrase\xf1a"),(0,t.kt)("li",{parentName:"ul"},"JWT = SESION SIN ESTADO"),(0,t.kt)("li",{parentName:"ul"},"Session y  Passport(asi se trabajaba antes)  puede ser remplazado por JWT"),(0,t.kt)("li",{parentName:"ul"},"Flash para comunicar mensaje"),(0,t.kt)("li",{parentName:"ul"},"API REST = NO TRABAJAR CON SESIONES (NO GUARDAR SESIONES EN EL SERVIDOR)")))}d.isMDXComponent=!0}}]);