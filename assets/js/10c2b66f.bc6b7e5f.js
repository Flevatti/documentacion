"use strict";(self.webpackChunkdocumentacion=self.webpackChunkdocumentacion||[]).push([[1027],{5680:(e,a,n)=>{n.d(a,{xA:()=>u,yg:()=>g});var o=n(6540);function i(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function t(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);a&&(o=o.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?t(Object(n),!0).forEach((function(a){i(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function s(e,a){if(null==e)return{};var n,o,i=function(e,a){if(null==e)return{};var n,o,i={},t=Object.keys(e);for(o=0;o<t.length;o++)n=t[o],a.indexOf(n)>=0||(i[n]=e[n]);return i}(e,a);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(o=0;o<t.length;o++)n=t[o],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=o.createContext({}),c=function(e){var a=o.useContext(l),n=a;return e&&(n="function"==typeof e?e(a):r(r({},a),e)),n},u=function(e){var a=c(e.components);return o.createElement(l.Provider,{value:a},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var a=e.children;return o.createElement(o.Fragment,{},a)}},p=o.forwardRef((function(e,a){var n=e.components,i=e.mdxType,t=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),p=i,g=d["".concat(l,".").concat(p)]||d[p]||m[p]||t;return n?o.createElement(g,r(r({ref:a},u),{},{components:n})):o.createElement(g,r({ref:a},u))}));function g(e,a){var n=arguments,i=a&&a.mdxType;if("string"==typeof e||i){var t=n.length,r=new Array(t);r[0]=p;var s={};for(var l in a)hasOwnProperty.call(a,l)&&(s[l]=a[l]);s.originalType=e,s[d]="string"==typeof e?e:i,r[1]=s;for(var c=2;c<t;c++)r[c]=n[c];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7117:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>t,metadata:()=>s,toc:()=>c});var o=n(8168),i=(n(6540),n(5680));const t={sidebar_position:13},r="Autenticaci\xf3n JWT y Refresh Token en API REST",s={unversionedId:"C--/autenticacion",id:"C--/autenticacion",title:"Autenticaci\xf3n JWT y Refresh Token en API REST",description:"- Con la autenticaci\xf3n JWT podemos confirmar el acceso a nuestras API solo a los usuarios autorizados.",source:"@site/docs/C--/autenticacion.md",sourceDirName:"C--",slug:"/C--/autenticacion",permalink:"/documentacion/docs/C--/autenticacion",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/C--/autenticacion.md",tags:[],version:"current",sidebarPosition:13,frontMatter:{sidebar_position:13},sidebar:"C",previous:{title:"API con .NET Core",permalink:"/documentacion/docs/C--/API"},next:{title:"Autenticaci\xf3n JWT y Identity Core",permalink:"/documentacion/docs/C--/Identity"}},l={},c=[{value:"Creamos una BD",id:"creamos-una-bd",level:2},{value:"Crear proyectos y dependencias",id:"crear-proyectos-y-dependencias",level:2},{value:"Creamos el proyecto",id:"creamos-el-proyecto",level:4},{value:"Ahora vamos a instalar las dependencias",id:"ahora-vamos-a-instalar-las-dependencias",level:4},{value:"Configuraci\xf3n de la base de datos",id:"configuraci\xf3n-de-la-base-de-datos",level:4},{value:"Configuraci\xf3n de servicios",id:"configuraci\xf3n-de-servicios",level:2},{value:"Llamamos al servicio",id:"llamamos-al-servicio",level:2},{value:"Controlador",id:"controlador",level:2},{value:"Controlador para autenticarse",id:"controlador-para-autenticarse",level:2},{value:"Lo probamos",id:"lo-probamos",level:4},{value:"Implementaci\xf3n de Refresh Token",id:"implementaci\xf3n-de-refresh-token",level:2},{value:"En la BD",id:"en-la-bd",level:4},{value:"Hacemos select",id:"hacemos-select",level:4},{value:"Creamos la tabla para el Refresh token",id:"creamos-la-tabla-para-el-refresh-token",level:4},{value:"En el proyecto",id:"en-el-proyecto",level:4},{value:"Empecemos con la l\xf3gica",id:"empecemos-con-la-l\xf3gica",level:4}],u={toc:c},d="wrapper";function m(e){let{components:a,...n}=e;return(0,i.yg)(d,(0,o.A)({},u,n,{components:a,mdxType:"MDXLayout"}),(0,i.yg)("h1",{id:"autenticaci\xf3n-jwt-y-refresh-token-en-api-rest"},"Autenticaci\xf3n JWT y Refresh Token en API REST"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Con la autenticaci\xf3n JWT podemos confirmar el acceso a nuestras API solo a los usuarios autorizados."),(0,i.yg)("li",{parentName:"ul"},"Se usar\xe1 el Refresh Token para generar el token sin preguntar las credenciales al usuario.")),(0,i.yg)("p",null,(0,i.yg)("img",{parentName:"p",src:"https://dc722jrlp2zu8.cloudfront.net/media/uploads/2019/12/04/cap3-seguridad2.png",alt:"Imagen para explicar"})),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Los JWT se utilizan como una forma segura de autenticar usuarios y compartir informaci\xf3n. Normalmente, el emisor utiliza una clave privada o secreta para firmar el JWT. El receptor del JWT verificar\xe1 la firma para asegurarse de que el token no haya sido alterado despu\xe9s de que fue firmado por el emisor."),(0,i.yg)("li",{parentName:"ul"},"B\xe1sicamente el token es una \u201cllave\u201d con la cual podemos acceder a informaci\xf3n protegida."),(0,i.yg)("li",{parentName:"ul"},"La llave tiene informaci\xf3n p\xfablica y una firma privada."),(0,i.yg)("li",{parentName:"ul"},"A trav\xe9s de la firma, comprobamos que el token sea valido y que no se alter\xf3.")),(0,i.yg)("h2",{id:"creamos-una-bd"},"Creamos una BD"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En sql server management , ejecutamos los siguientes comandos sql:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-sql"},"create database dbprueba\nuse dbprueba;\nCREATE TABLE Usuario(\nIdUsuario int primary key identity,\nNombreUsuario varchar(20) ,\nClave varchar(20)\n)\n\ninsert into Usuario(NombreUsuario , Clave) values ('Admin' , '123');\n\n")),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Identity es como auto_incremental.")))),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"info")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://sqlserverdb.com/sql-identity/#google_vignette"},"SQL IDENTITY: Columna de identidad en SQL")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://www.tutorialesprogramacionya.com/sqlserverya/temarios/descripcion.php?cod=19&punto=13&inicio="},"Campo con atributo Identity"))))),(0,i.yg)("h2",{id:"crear-proyectos-y-dependencias"},"Crear proyectos y dependencias"),(0,i.yg)("h4",{id:"creamos-el-proyecto"},"Creamos el proyecto"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Creamos un nuevo proyecto con la plantilla ASP.NET Core Web API:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Nombre del proyecto: ProyectoToken."),(0,i.yg)("li",{parentName:"ul"},"Usaremos la versi\xf3n .NET 7.0"),(0,i.yg)("li",{parentName:"ul"},"Desmarcamos la opcion \u201cConfigurar para HTTPS\u201d porque no queremos instalar el certificado.")))),(0,i.yg)("h4",{id:"ahora-vamos-a-instalar-las-dependencias"},"Ahora vamos a instalar las dependencias"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"En el nombre del proyecto \u2013 click derecho \u2013 Administrar Paquetes Nuget."),(0,i.yg)("li",{parentName:"ol"},"En la pesta\xf1a examinar, buscamos y instalamos:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Microsoft.EntityFrameworkCore.SqlServer (La misma versi\xf3n que el proyecto)"),(0,i.yg)("li",{parentName:"ul"},"Microsoft.EntityFrameworkCore.Tools (La misma versi\xf3n que el proyecto)"),(0,i.yg)("li",{parentName:"ul"},"Microsoft.AspNetCore.Authentication.JwtBearer (La misma versi\xf3n que el proyecto)"),(0,i.yg)("li",{parentName:"ul"},"System.IdentityModel.Tokens.Jwt")))),(0,i.yg)("h4",{id:"configuraci\xf3n-de-la-base-de-datos"},"Configuraci\xf3n de la base de datos"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Usaremos la metodolog\xeda Database First (es lo mismo que Code First).")),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"En el proyecto creamos la carpeta Models."),(0,i.yg)("li",{parentName:"ol"},"Herramientas \u2013 Administrador de paquetes NuGet \u2013 Consola del Administrador de paquetes."),(0,i.yg)("li",{parentName:"ol"},"En la consola ejecutamos el comando:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-powershell"},'Scaffold-DbContext "Server=(local); DataBase=dbprueba; Trusted_Connection=True; TrustServerCertificate=True;" Microsoft.EntityFrameworkCore.SqlServer -OutPutDir Models\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Este comando genera el c\xf3digo para el dbContext y los modelos de una base de datos."),(0,i.yg)("li",{parentName:"ul"},"B\xe1sicamente crea todo el dbContext y los modelos a partir de una base de datos existente."),(0,i.yg)("li",{parentName:"ul"},"Tiene:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"La cadena de conexi\xf3n."),(0,i.yg)("li",{parentName:"ul"},"El paquete que se va a utilizar para conectarse a la bd."),(0,i.yg)("li",{parentName:"ul"},"Con OutputDir especificamos en que carpeta colocamos los\narchivos de clase que representan una entidad (tabla).")))))),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"info")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://learn.microsoft.com/en-us/ef/core/cli/powershell"},"Entity Framework Core tools reference - Package Manager Console in Visual Studio"))))),(0,i.yg)("ol",{start:4},(0,i.yg)("li",{parentName:"ol"},"Una vez ejecutado el comando, en la carpeta Models se genera una clase que representa el modelo (tabla) y otra clase que es el DbContext.")),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En appsettings.json:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-json"},'  "ConnectionStrings": {\n    "cadenaSql": "Server=(local);DataBase=dbprueba;Trusted_Connection=True;TrustServerCertificate=True;"\n  }\n}\n\n')),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En Progam.cs:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'using Microsoft.EntityFrameworkCore;\nusing ProyectoToken.Models;\n\nvar builder = WebApplication.CreateBuilder(args);\n\n// Add services to the container.\n\nbuilder.Services.AddControllers();\n// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle\nbuilder.Services.AddEndpointsApiExplorer();\nbuilder.Services.AddSwaggerGen();\nbuilder.Services.AddDbContext<DbpruebaContext>(option =>\n{\n    option.UseSqlServer(builder.Configuration.GetConnectionString("cadenaSql"));\n});\nvar app = builder.Build();\n\n')),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En la clase DbpruebaContext.cs:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)\n    {\n\n    }\n\n")),(0,i.yg)("h2",{id:"configuraci\xf3n-de-servicios"},"Configuraci\xf3n de servicios"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En la carpeta Models, creamos la carpeta Custom."),(0,i.yg)("li",{parentName:"ul"},"Dentro de Custom , creamos una clase llamada AutorizacionRequest y contendr\xe1 lo siguiente:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"namespace ProyectoToken.Models.Custom\n{\n    public class AutorizacionRequest\n    {\n        public string NombreUsuario { get; set; }\n        public string Clave { get; set; }\n    }\n}\n\n")),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},'Si desea quitar la advertencia  "el valor puede ser null" , deber\xeda hacer lo siguiente:',(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Hacemos click en el nombre del proyecto y en Nullable le asignamos disable:")))),(0,i.yg)("pre",{parentName:"div"},(0,i.yg)("code",{parentName:"pre",className:"language-html"},"<Nullable>disable</Nullable>\n")))),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En la carpeta Custom , creamos una clase llamada AutorizacionResponse y contendr\xe1 lo siguiente:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"namespace ProyectoToken.Models.Custom\n{\n    public class AutorizacionResponse\n    {\n        public string Token { get; set; }\n\n        // Es true si se genero el token\n        public bool Resultado { get; set; }\n\n\n        public string Msg { get; set; }\n    }\n}\n\n")),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En appsettings.json")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "Logging": {\n    "LogLevel": {\n      "Default": "Information",\n      "Microsoft.AspNetCore": "Warning"\n    }\n  },\n  "AllowedHosts": "*",\n  "ConnectionStrings": {\n    "cadenaSql": "Server=(local);DataBase=dbprueba;Trusted_Connection=True;TrustServerCertificate=True;"\n  },\n  "JwtSetting": {\n       "key" :  "=codigo_estudiante_jwt= esta es la llave para firmar el token"\n  }\n}\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"El valor de la clave key puede ser cualquier String, se recomienda que sea largo (si es corto puede haber un error) y dif\xedcil de adivinar."),(0,i.yg)("li",{parentName:"ul"},"Se utilizar\xe1 el valor de la clave key para crear el token.")))),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En el proyecto, creamos la carpeta Services."),(0,i.yg)("li",{parentName:"ul"},"Dentro de esta , a\xf1adimos la interfaz IAutorizacionService , que contendr\xe1 lo siguiente:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"using ProyectoToken.Models.Custom;\n\nnamespace ProyectoToken.Services\n{\n    public interface IAutorizacionService\n    {\n        Task<AutorizacionResponse> DevolverToken(AutorizacionResponse autorizacion);\n    }\n}\n\n")),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En la carpeta Services, creamos la clase AutorizacionService , que contendr\xe1 lo siguiente:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'using Microsoft.IdentityModel.Tokens;\nusing ProyectoToken.Models;\nusing ProyectoToken.Models.Custom;\nusing System.IdentityModel.Tokens.Jwt;\nusing System.Security.Claims;\nusing System.Text;\n\nnamespace ProyectoToken.Services\n{\n    public class AutorizacionService : IAutorizacionService\n    {\n\n\n        private readonly DbpruebaContext _context;\n        private readonly IConfiguration _configuration;\n\n        public AutorizacionService(DbpruebaContext context, IConfiguration configuration)\n        {\n            _context = context;\n            _configuration = configuration;\n        }\n\n\n        private string GenerarToken(string idUsuario)\n        {\n            var key = _configuration.GetValue<string>("JwtSetting:key");\n            // Convertimos la key en un array de  bytes\n            var keyBytes = Encoding.ASCII.GetBytes(key);\n\n            // Creamos la informaci\xf3n del usuario para el token\n            // creamos un ClaimsIdentity , que representa una identidad\n            var claims = new ClaimsIdentity();\n            // Le a\xf1adimos una notificac\xedon (claim) a la identidad\n            claims.AddClaim(new Claim(ClaimTypes.NameIdentifier , idUsuario));\n\n            // Creamos una credencial\n            var credencialesToken = new SigningCredentials(new SymmetricSecurityKey(keyBytes),\n\n                SecurityAlgorithms.HmacSha256Signature\n                );\n\n            // Creamos el detalle de nuestro token\n            var tokenDescriptor = new SecurityTokenDescriptor\n            {\n                Subject = claims,\n                // Expira un minuto\n                Expires = DateTime.UtcNow.AddMinutes(1),\n                SigningCredentials = credencialesToken\n            };\n\n            // Creamos los controladores del token\n            var tokenHandler = new JwtSecurityTokenHandler();\n            var tokenConfig = tokenHandler.CreateToken(tokenDescriptor);\n            string tokenCreado = tokenHandler.WriteToken(tokenConfig);\n            return tokenCreado;\n        }\n\n        public Task<AutorizacionResponse> DevolverToken(AutorizacionResponse autorizacion)\n        {\n            throw new NotImplementedException(\n                );\n        }\n    }\n}\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"_configuration.GetValue","<","TipoDato>(\u201cX\u201d) , devuelve el valor de la clave X de appsettings.json"),(0,i.yg)("li",{parentName:"ul"},"_configuration.GetValue","<","TipoDato>(\u201cX:Y\u201d), si Usamos \u201cX:Y\u201d , es porque la clave \u201cY\u201d se encuentra adentro de la clave \u201cX\u201d."),(0,i.yg)("li",{parentName:"ul"},"El TipoDato, es el tipo de dato que se va a retornar, sirve para especificar si se desea hacer un casting.")))),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Clase ClaimsIdentity y Claims")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"La clase ClaimsIdentity:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Representa una identidad."),(0,i.yg)("li",{parentName:"ul"},"Contiene una colecci\xf3n de notificaciones que definen el nombre, la funci\xf3n y otros atributos del usuario. Esta clase ayuda a autenticar y autorizar usuarios y controlar el acceso a varios recursos en la aplicaci\xf3n."),(0,i.yg)("li",{parentName:"ul"},"Las notificaciones contenidas en un ClaimsIdentity  se pueden usar para tomar decisiones de autorizaci\xf3n y autenticaci\xf3n."))),(0,i.yg)("li",{parentName:"ul"},"La clase Claim:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Representa una notificaci\xf3n."),(0,i.yg)("li",{parentName:"ul"},"Cada claim es un fragmento de informaci\xf3n sobre el usuario, como pueden ser, nombre de usuario, correo electr\xf3nico, rol, localidad a la que pertenece, etc."),(0,i.yg)("li",{parentName:"ul"},"La forma m\xe1s sencilla de crear un Claim es proporcionando un tipo de dato y un valor en el constructor del Claim. El valor del claim se representa con un valor string."),(0,i.yg)("li",{parentName:"ul"},"Para representar el tipo de dato del claim tenemos la clase ClaimTypes, donde se representan los tipos predefinidos de claims m\xe1s comunes."),(0,i.yg)("li",{parentName:"ul"},"Una reclamaci\xf3n(claim) es un par clave-valor asignado a un usuario por una fuente confiable. Un reclamo define quien es el usuario."),(0,i.yg)("li",{parentName:"ul"},'La "clave" suele llamarse  tipo de notificaci\xf3n/reclamo/dato y por lo general tiene formato de url.'),(0,i.yg)("li",{parentName:"ul"},"Una identidad puede contener m\xfaltiples reclamaciones; Algunos ejemplos son la identificaci\xf3n, el nombre y el correo electr\xf3nico del usuario, por nombrar solo algunos.")))))),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Clase SigningCredentials ")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Representa los algoritmos de seguridad y clave criptogr\xe1fica que se utilizan para generar una firma digital."),(0,i.yg)("li",{parentName:"ul"},"El constructor que usamos tiene dos par\xe1metros:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Clave de firma: Es una SecurityKey que contiene la ",(0,i.yg)("a",{parentName:"li",href:"https://www.cloudflare.com/es-es/learning/ssl/what-is-a-cryptographic-key/"},"clave criptogr\xe1fica")," que se utiliza para generar la firma digital.  . Puede ser una instancia de SymmetricSecurityKey que representa una clase base abstracta para todas las claves que se usan con algoritmos sim\xe9tricos. Recibe como par\xe1metro un array de bytes (la clave criptogr\xe1fica)."),(0,i.yg)("li",{parentName:"ul"},"firmaAlgoritmo: Una URI que representa el ",(0,i.yg)("a",{parentName:"li",href:"https://developer.mozilla.org/es/docs/Glossary/Cipher"},"algoritmo criptogr\xe1fico")," que se utiliza para generar la firma digital. La clase SecurityAlgorithms contiene las URI que se pueden usar.")))))),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Clase SecurityTokenDescriptor")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Contiene la informaci\xf3n que se utiliza para crear el token."),(0,i.yg)("li",{parentName:"ul"},"Propiedad Subject : Es un ClaimsIdentity. Establece los claims que ser\xe1n incluido en el token."),(0,i.yg)("li",{parentName:"ul"},"Propiedad Expires: Especifica cuando se va a expirar el token."),(0,i.yg)("li",{parentName:"ul"},"Propiedad SigningCredentials : Especifica las credenciales que se utiliza para firmar el token. Su valor es una instancia de tipo SigningCredentials. Basicamente especificamos como se va a firmar el token.")))),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Clase JwtSecurityTokenHandler")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Se usa para crear y validar tokens web Json."),(0,i.yg)("li",{parentName:"ul"},"El m\xe9todo CreateToken se usa para crear un token, solo recibe una instancia de tipo SecurityTokenDescriptor."),(0,i.yg)("li",{parentName:"ul"},"El m\xe9todo WriteToken() serializa el token que le pasamos. En otras palabras, toma un token de seguridad y lo ",(0,i.yg)("a",{parentName:"li",href:"https://learn.microsoft.com/es-es/dotnet/standard/serialization/"},"serializa")," en una cadena(string) JWT que puede ser utilizada para la autenticaci\xf3n y autorizaci\xf3n en aplicaciones web y servicios que utilizan JWT como mecanismo de seguridad. El m\xe9todo toma un SecurityToken como argumento y devuelve una cadena(String) que representa el token JWT.")))),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("p",{parentName:"div"},"Si seleccionas los campos privados y haces click derecho, en la opcion \u201cAcciones r\xe1pidas y refactorizaciones\u201d podes generar el constructor."))),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Completamos el m\xe9todo que implementa de la interfaz:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'     public async Task<AutorizacionResponse> DevolverToken(AutorizacionRequest autorizacion)\n        {\n            var usuario_encontrado = _context.Usuarios.FirstOrDefault( x => \n            x.NombreUsuario == autorizacion.NombreUsuario && x.Clave == autorizacion.Clave);\n\n            if (usuario_encontrado == null)\n            {\n                return await Task.FromResult<AutorizacionResponse>(null);\n            }\n\n            string tokenCreado = GenerarToken(usuario_encontrado.IdUsuario.ToString());\n            return new AutorizacionResponse() { Token = tokenCreado, Resultado = true, Msg = "Ok" };\n\n\n        }\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"El m\xe9todo FromResultado","<","T>(X) crea un objeto Task","<","T> que se ha completado correctamente con el resultado especificado(X). Entonces recibe:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"T: Tipo de dato que devuelve la tarea."),(0,i.yg)("li",{parentName:"ul"},"X: El resultado que se va a almacenar en la tarea(task) completada."))),(0,i.yg)("li",{parentName:"ul"},"Recordatorio: Con el await, conseguimos el valor del resultado que se almacena en la tarea completada.")))),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Como nos equivocamos con el tipo de dato de los par\xe1metros en la interfaz que se implementa, lo corregimos:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"using ProyectoToken.Models.Custom;\n\nnamespace ProyectoToken.Services\n{\n    public interface IAutorizacionService\n    {\n        Task<AutorizacionResponse> DevolverToken(AutorizacionRequest autorizacion);\n    }\n}\n\n")),(0,i.yg)("h2",{id:"llamamos-al-servicio"},"Llamamos al servicio"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En Progam.cs:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'using Microsoft.AspNetCore.Authentication.JwtBearer;\nusing Microsoft.EntityFrameworkCore;\nusing Microsoft.Extensions.Configuration;\nusing Microsoft.IdentityModel.Tokens;\nusing ProyectoToken.Models;\nusing ProyectoToken.Services;\nusing System.Text;\n\nvar builder = WebApplication.CreateBuilder(args);\n\n// Add services to the container.\n\nbuilder.Services.AddControllers();\n// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle\nbuilder.Services.AddEndpointsApiExplorer();\nbuilder.Services.AddSwaggerGen();\nbuilder.Services.AddDbContext<DbpruebaContext>(option =>\n{\n    option.UseSqlServer(builder.Configuration.GetConnectionString("cadenaSql"));\n});\nbuilder.Services.AddScoped<IAutorizacionService, AutorizacionService>();\nvar key = builder.Configuration.GetValue<string>("JwtSetting:key");\n// Convertimos la key en un array de  bytes\nvar keyBytes = Encoding.ASCII.GetBytes(key);\nbuilder.Services.AddAuthentication(config =>\n{\n    config.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;\n    config.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;\n}).AddJwtBearer(config =>\n{\n    config.RequireHttpsMetadata = false;\n    config.SaveToken = true;\n    config.TokenValidationParameters = new TokenValidationParameters\n    {\n        ValidateIssuerSigningKey = true,\n        IssuerSigningKey = new SymmetricSecurityKey(keyBytes),\n        ValidateIssuer = false,\n        ValidateAudience = false,\n        ValidateLifetime = true,\n        ClockSkew = TimeSpan.Zero\n    };\n});\n\n\nvar app = builder.Build();\n\n// Configure the HTTP request pipeline.\nif (app.Environment.IsDevelopment())\n{\n    app.UseSwagger();\n    app.UseSwaggerUI();\n}\napp.UseAuthentication();\napp.UseAuthorization();\n\napp.MapControllers();\n\napp.Run();\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"la linea builder.Configuration.GetValue","<",'string>("JwtSetting:key"); equivale a la primera l\xednea de c\xf3digo del m\xe9todo GenerarToken(). Entonces  _configuration es igual a builder.Configuration'),(0,i.yg)("li",{parentName:"ul"},"AddAuthentication() registra los servicios requeridos por los servicios de autenticaci\xf3n. Recibe un delegado donde configura la autenticaci\xf3n."),(0,i.yg)("li",{parentName:"ul"},"AddJwtBearer()  habilita la autenticaci\xf3n del portador JWT utilizando el esquema predeterminado. La autenticaci\xf3n de portador JWT realiza la autenticaci\xf3n extrayendo y validando un token JWT del encabezado Authorization de la solicitud. Tambien recibe un delegado para poder configurarlo."),(0,i.yg)("li",{parentName:"ul"},"UseAuthentication() habilita un middleware para la autenticaci\xf3n.")))),(0,i.yg)("h2",{id:"controlador"},"Controlador"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En la carpeta controllers, creamos un controlador de API en blanco llamado PaisesController."),(0,i.yg)("li",{parentName:"ul"},"Este contendr\xe1 lo siguiente:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'using Microsoft.AspNetCore.Authorization;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.AspNetCore.Mvc;\n\nnamespace ProyectoToken.Controllers\n{\n    [Route("api/[controller]")]\n    [ApiController]\n    public class PaisesController : ControllerBase\n    {\n        [Authorize]\n        [HttpGet]\n        [Route("Lista")]\n        public async Task<IActionResult> Lista()\n        {\n            var listaPaises = await Task.FromResult(new List<string> { "Argentina", "Francia", "Croacia", "Marruecos" });\n            return Ok(listaPaises);\n\n        }\n    }\n}\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Podemos utilizar El par\xe1metro posicional del atributo Route para indicar cu\xe1l es la ruta(endpoint) para solicitar la acci\xf3n (De la misma forma que se hace con los atributos ","[HttpVerbo]",")."),(0,i.yg)("li",{parentName:"ul"},"Esta vez no usamos el par\xe1metro de tipo gen\xe9rico de Task.FromResult ya que el valor se asigna de forma autom\xe1tica y es igual al   tipo de dato de la instancia que se crea en el par\xe1metro normal."),(0,i.yg)("li",{parentName:"ul"},"Con el atributo ","[Authorize]"," estamos diciendo que el endpoint solo puede ser ejecutado/usado por un usuario que contenga el token y este autenticado.")))),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Diferencia entre los atributos ","[HttpVerbo]"," y ","[Route]")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},'En .NET Core, tanto HttpGet("") como Route("") son atributos que se utilizan para configurar el enrutamiento de una acci\xf3n en un controlador. Sin embargo, tienen diferentes prop\xf3sitos y aplicaciones.'),(0,i.yg)("li",{parentName:"ul"},"Al usar los dos para un verbo Get por ejemplo:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},'HttpGet(""):',(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Este atributo se utiliza para configurar una acci\xf3n en un controlador para que responda a las solicitudes HTTP GET."),(0,i.yg)("li",{parentName:"ul"},"Es \xfatil cuando deseas que una acci\xf3n responda solo a solicitudes GET y no a otros m\xe9todos HTTP como POST, PUT o DELETE."))),(0,i.yg)("li",{parentName:"ul"},'Route(""):',(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"El atributo Route se utiliza para personalizar la ruta de acceso que se debe usar para acceder a una acci\xf3n en un controlador."),(0,i.yg)("li",{parentName:"ul"},"Puede aplicarse a acciones que responden a diferentes m\xe9todos HTTP, incluyendo GET, POST, PUT, DELETE, etc."),(0,i.yg)("li",{parentName:"ul"},"Te permite definir una ruta de acceso personalizada."))))),(0,i.yg)("li",{parentName:"ul"},"Ejemplo:")),(0,i.yg)("pre",{parentName:"div"},(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'[HttpGet("mi-accion")]\npublic IActionResult MiAccion()\n{\n    // Esta acci\xf3n responder\xe1 solo a solicitudes GET a "/mi-accion".\n    return View();\n}\n\n[Route("otra-ruta")]\npublic IActionResult OtraAccion()\n{\n    // Esta acci\xf3n responder\xe1 a solicitudes GET a "/otra-ruta".\n    return View();\n}\n\n')),(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"En resumen, HttpGet se utiliza para especificar que una acci\xf3n responde exclusivamente a solicitudes GET, mientras que Route se usa para personalizar la ruta de acceso de una acci\xf3n, lo que puede aplicarse a varios m\xe9todos HTTP, incluyendo GET. Ambos atributos son herramientas \xfatiles para controlar el enrutamiento en aplicaciones .NET Core.")))),(0,i.yg)("h2",{id:"controlador-para-autenticarse"},"Controlador para autenticarse"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En la carpeta controllers, creamos un nuevo controlador (Controlador de API en blanco) llamado UsuarioController."),(0,i.yg)("li",{parentName:"ul"},"En UsuarioController.cs:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'using Microsoft.AspNetCore.Http;\nusing Microsoft.AspNetCore.Mvc;\nusing ProyectoToken.Models.Custom;\nusing ProyectoToken.Services;\n\nnamespace ProyectoToken.Controllers\n{\n    [Route("api/[controller]")]\n    [ApiController]\n    public class UsuarioController : ControllerBase\n    {\n        private readonly IAutorizacionService _autorizacionService;\n\n        public UsuarioController(IAutorizacionService autorizacionService)\n        {\n            _autorizacionService = autorizacionService;\n        }\n\n\n        [HttpPost]\n        [Route("Autenticar")] \n        public async Task<IActionResult> Autenticar([FromBody] AutorizacionRequest autorizacion)\n        {\n            var resultado_autorizacion = await _autorizacionService.DevolverToken(autorizacion);\n            if (resultado_autorizacion == null)\n            {\n                return Unauthorized();\n            }\n            return Ok(resultado_autorizacion);\n        }\n    }\n}\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Unauthorized() devuelve el c\xf3digo de estado 401 (El  usuario no posee los permisos necesarios para cierta acci\xf3n)."),(0,i.yg)("li",{parentName:"ul"},"Los servicios no solo se generan (inyectan como dependencia) en el constructor de un controlador, sino tambi\xe9n en los servicios (f\xedjate en AutorizacionService). Entonces un servicio tambi\xe9n puede usar otros servicios a trav\xe9s de la inyecci\xf3n de dependencia.")))),(0,i.yg)("h4",{id:"lo-probamos"},"Lo probamos"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Nos devolver\xeda algo asi:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiIxIiwibmJmIjoxNjk4MDYyMjI1LCJleHAiOjE2OTgwNjIyODQsImlhdCI6MTY5ODA2MjIyNX0.JFbUZ_2-79bZEe4Az-hip2fgBMA-eOK384uawtW6Xfs",\n  "resultado": true,\n  "msg": "Ok"\n}\n\n')),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Lo probamos en el sitio web ",(0,i.yg)("a",{parentName:"li",href:"https://jwt.io/"},"jwt.io"),": ",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"En Encoded : Copiamos el token."),(0,i.yg)("li",{parentName:"ul"},"En verify Signature: Copiamos el valor de \u201ckey\u201d de appsettings.json."),(0,i.yg)("li",{parentName:"ul"},"Como podemos observar, el payload almacena informaci\xf3n del token como el tiempo de expiraci\xf3n, cuando fue emitido, a partir de cuando lo pod\xe9s usar y los \u201cclaims (reclamos)\u201d que a\xf1adimos.")))),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Entonces si hacemos una petici\xf3n a http://localhost:5280/api/Paises/Lista no nos deja entrar porque no estamos autorizado."),(0,i.yg)("li",{parentName:"ul"},"Pero si en la cabecera enviamos Authorization: Bearer ","[Ingrese el token]",", podemos acceder a la informaci\xf3n.")),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Si desea enviar el token por swagger , eche un vistazo a esta ",(0,i.yg)("a",{parentName:"li",href:"https://www.c-sharpcorner.com/article/how-to-add-jwt-bearer-token-authorization-functionality-in-swagger/"},"gu\xeda"),". ")))),(0,i.yg)("h2",{id:"implementaci\xf3n-de-refresh-token"},"Implementaci\xf3n de Refresh Token"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"El Refresh token seria \u201cotra llave\u201d que el servidor te devolver\xe1 al autenticarse."),(0,i.yg)("li",{parentName:"ul"},"Entonces al autenticarse te devuelve dos llaves, el token \u201cverdadero\u201d (el que implementamos anteriormente, se suele llamar Access token\n) y un Refresh token."),(0,i.yg)("li",{parentName:"ul"},"El Refresh token quedara almacenado en un alg\xfan lugar del sitio web."),(0,i.yg)("li",{parentName:"ul"},"Cuando el token \u201cverdadero\u201d expira o se elimina (por ejemplo, cambiamos de p\xe1gina) utilizamos el Refresh token para volver a generar el Access token."),(0,i.yg)("li",{parentName:"ul"},"La API Recibe un Refresh token, lo valida y luego genera el token verdadero y otro Refresh token (esto es opcional, depende de cada implementaci\xf3n)."),(0,i.yg)("li",{parentName:"ul"},"El Refresh token debe durar m\xe1s que el Access token, ya que con este se obtiene el token \u201cverdadero\u201d."),(0,i.yg)("li",{parentName:"ul"},"El tiempo de duraci\xf3n de una sesion activa depende del Refresh token."),(0,i.yg)("li",{parentName:"ul"},"Por lo general una sesion debe durar el mismo tiempo que el Refresh token.")),(0,i.yg)("h4",{id:"en-la-bd"},"En la BD"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Creamos una nueva tabla con el siguiente comando:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-sql"},"create table TABLA_PRUEBA (\n\nFechaCreacion datetime,\nFechaExpiracion Datetime ,\nEsActivo AS (iif(FechaExpiracion < getdate() , convert(bit,0) , convert(bit,1)))\n)\n\n")),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Iif() devuelve uno de dos valores, dependiendo si la expresi\xf3n booleana se eval\xfaa como true o como false en SQL Server. El primer par\xe1metro es la expresi\xf3n booleana, el segundo par\xe1metro representa el valor que se devuelve si la expresi\xf3n es true y el tercero par\xe1metro representa el valor que se devuelve si la expresi\xf3n es false."),(0,i.yg)("li",{parentName:"ul"},"Se utiliza el \u201cAS\u201d para especificar que el valor de esa columna, se basa en un calculo (en este caso de iif) y por lo tanto se asigna solo."),(0,i.yg)("li",{parentName:"ul"},"Convert(X,Y) convierte la expresi\xf3n Y en el tipo de dato X. Entonces en el c\xf3digo sql anterior , si es true retorna un 0 convertido en bit y si es false retorna un 1 convertido en bit.")))),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Insertamos un valor en la tabla:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO TABLA_PRUEBA(FechaCreacion , FechaExpiracion )\nVALUES (getdate() , dateadd(second,10,getdate()));\n\n")),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"getdate() devuelve un valor Datetime que representa la fecha/hora actual. "),(0,i.yg)("li",{parentName:"ul"},"dateadd() modifica una fecha/hora y luego la devuelve (modificada). El primer par\xe1metro especifica qu\xe9 medida/unidad (minutos, segundos, meses, a\xf1os, etc) se utilizar\xe1 para modificar el Datetime, el segundo par\xe1metro es un valor int que ser\xe1 lo que se le sumara al Datetime utilizando la medida que se especifico en el primer par\xe1metro y el tercer par\xe1metro es el Datetime que se modificara. En el comando sql que utilizamos, le estamos aumentando 10 segundos a la fecha/hora actual.")))),(0,i.yg)("h4",{id:"hacemos-select"},"Hacemos select"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Si luego hacemos Select luego de crearla, el valor de la columna EsActivo  es 1 y luego de 10 segundos es 0 , el valor se va actualizando autom\xe1tica ya que gracias al \u201cAS\u201d es una columna calculada/virtualizada que no est\xe1 almacenada f\xedsicamente en la tabla, el calculo se hace cada vez que se realiza la consulta.")),(0,i.yg)("h4",{id:"creamos-la-tabla-para-el-refresh-token"},"Creamos la tabla para el Refresh token"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"La tabla anterior la borramos solo era de ejemplo, ahora creamos la tabla para el Refresh token:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE HistorialRefreshToken (\nIdHistorialToken int primary key identity,\nIdUsuario int references Usuario(IdUsuario),\nToken varchar(500),\nRefreshToken varchar(200),\nFechaCreacion datetime,\nFechaExpiracion datetime,\nEsActivo as (iif(FechaExpiracion < getdate() , convert(bit,0), convert(bit,1)))\n);\n\n")),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"IdUsuario es una fk que hace referencia a una fila de la tabla Usuario."),(0,i.yg)("li",{parentName:"ul"},"La sintaxis para hacer una fk es: NombreColumna tipodedato  references tabla-a-la-cual-se-referencia(columna-a-la-que-se-referencia).")))),(0,i.yg)("h4",{id:"en-el-proyecto"},"En el proyecto"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Herramientas \u2013 Administrador de paquetes Nuget \u2013 Consola."),(0,i.yg)("li",{parentName:"ol"},"En la consola ejecutamos:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-powershell"},'Scaffold-DbContext "Server=(local); DataBase=dbprueba; Trusted_Connection=True; TrustServerCertificate=True;" Microsoft.EntityFrameworkCore.SqlServer -OutPutDir Models -force \n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Con -force forzamos la actualizaci\xf3n (b\xe1sicamente sobrescribimos todos los archivos ya generados).")))),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En el DbPruebaContext.cs , vaciamos el cuerpo del m\xe9todo OnConfiguring:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder){}\n")),(0,i.yg)("h4",{id:"empecemos-con-la-l\xf3gica"},"Empecemos con la l\xf3gica"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En AutorizacionResponse.cs:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"namespace ProyectoToken.Models.Custom\n{\n    public class AutorizacionResponse\n    {\n        public string Token { get; set; }\n        public string RefreshToken { get; set; }\n        // Es true si se genero el token\n        public bool Resultado { get; set; }\n\n\n        public string Msg { get; set; }\n    }\n}\n\n")),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En Custom agregamos otra clase llamada RefreshTokenRequest y contendr\xe1 lo siguiente:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"namespace ProyectoToken.Models.Custom\n{\n    public class RefreshTokenRequest\n    {\n        public string TokenExpirado { get; set; }\n        public string RefreshToken { get; set; }\n    }\n}\n\n")),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"Tambi\xe9n almacenamos el token expirado.")))),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En IAutorizacionService:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},"using ProyectoToken.Models.Custom;\n\nnamespace ProyectoToken.Services\n{\n    public interface IAutorizacionService\n    {\n        Task<AutorizacionResponse> DevolverToken(AutorizacionRequest autorizacion);\n        Task<AutorizacionResponse> DevolverRefreshToken(RefreshTokenRequest refreshTokenRequest , int idUsuario);\n    }\n}\n\n")),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En AutorizacionService.cs:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'private string GenerarRefreshToken()\n        {\n            var byteArray = new byte[64];\n            var refreshToken = "";\n            using (var rng = RandomNumberGenerator.Create())\n            {\n                rng.GetBytes(byteArray);\n                refreshToken = Convert.ToBase64String(byteArray);\n\n            }\n            return refreshToken;\n        }\n        public async Task<AutorizacionResponse> DevolverToken(AutorizacionRequest autorizacion)\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"RandomNumberGenerator.Create() Devuelve una instancia de RandomNumberGenerator que provee m\xe9todos para generar valores aleatorios. Este generador de n\xfameros aleatorios criptogr\xe1ficos crea valores aleatorios criptogr\xe1ficamente fuertes."),(0,i.yg)("li",{parentName:"ul"},"Con el m\xe9todo GetBytes() llenamos el array con bytes aleatorios criptogr\xe1ficamente fuertes."),(0,i.yg)("li",{parentName:"ul"},"Convert.ToBase64String() Convierte una matriz de  bytes en su representaci\xf3n de cadena(string) equivalente codificada con d\xedgitos en base 64.  La matriz es de enteros sin signo de 8 bits.")))),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'      private async Task<AutorizacionResponse> GuardarHistorialRefreshToken(int idUsuario , string token , string refreshToken)\n        {\n            var historialRefreshToken = new HistorialRefreshToken\n            {\n                IdUsuario = idUsuario,\n                Token = token,\n                RefreshToken = refreshToken,\n                FechaCreacion = DateTime.UtcNow,\n                // Deberia ser horas y inclusos dias\n                FechaExpiracion = DateTime.UtcNow.AddMinutes(2)\n\n            };\n\n            await _context.HistorialRefreshTokens.AddAsync(historialRefreshToken);\n            await _context.SaveChangesAsync();\n            return new AutorizacionResponse { Token = token , RefreshToken = refreshToken , Resultado = true , Msg="Ok" };\n        }\n        public async Task<AutorizacionResponse> DevolverToken(AutorizacionRequest autorizacion)\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"DateTime.UtcNow Devuelve la fecha y hora actual del equipo, expresada como hora universal coordinada (UTC)."),(0,i.yg)("li",{parentName:"ul"},"Con AddMinutes(X) , le a\xf1adimos X minutos al DateTime especificado. Tambi\xe9n puede ser usar otros m\xe9todos de DateTime para a\xf1adirle horas, dias, etc.")))),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'   public async Task<AutorizacionResponse> DevolverToken(AutorizacionRequest autorizacion)\n        {\n            var usuario_encontrado = _context.Usuarios.FirstOrDefault( x => \n            x.NombreUsuario == autorizacion.NombreUsuario && x.Clave == autorizacion.Clave);\n\n            if (usuario_encontrado == null)\n            {\n                return await Task.FromResult<AutorizacionResponse>(null);\n            }\n\n            string tokenCreado = GenerarToken(usuario_encontrado.IdUsuario.ToString());\n            string refreshTokenCreado = GenerarRefreshToken();\n            //return new AutorizacionResponse() { Token = tokenCreado, Resultado = true, Msg = "Ok" };\n            return await GuardarHistorialRefreshToken(usuario_encontrado.IdUsuario , tokenCreado , refreshTokenCreado);\n\n        }\n\n')),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'  public async Task<AutorizacionResponse> DevolverRefreshToken(RefreshTokenRequest refreshTokenRequest, int idUsuario)\n        {\n            var refreshTokenEncontrado = _context.HistorialRefreshTokens.FirstOrDefault(x =>\n                 x.Token == refreshTokenRequest.TokenExpirado && x.RefreshToken == refreshTokenRequest.RefreshToken\n                 && x.IdUsuario == idUsuario\n            );\n            if (refreshTokenEncontrado == null)\n            {\n                return new AutorizacionResponse { Resultado = false, Msg = "No existe refreshToken" };\n            }\n            var refreshTokenCreado = GenerarRefreshToken();\n            var tokenCreado = GenerarToken(idUsuario.ToString());\n\n            return await GuardarHistorialRefreshToken(idUsuario, tokenCreado, refreshTokenCreado);\n        }\n\n')),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"En UsuarioController.cs:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-csharp"},'[HttpPost]\n        [Route("ObtenerRefreshToken")]\n        public async Task<IActionResult> ObtenerRefreshToken([FromBody] RefreshTokenRequest request)\n        {\n            var tokenHandler = new JwtSecurityTokenHandler();\n            var tokenExpiradoSupuestamente = tokenHandler.ReadJwtToken(request.TokenExpirado);\n            // Si el token es mayor que la fecha actual , es porque todavia no ha expirado\n            if (tokenExpiradoSupuestamente.ValidTo > DateTime.UtcNow)\n            {\n                return BadRequest(new AutorizacionResponse {Resultado = false , Msg = "Token no expirado" });\n            }\n            string idUsuario = tokenExpiradoSupuestamente.Claims.First(x => \n            x.Type == JwtRegisteredClaimNames.NameId).Value.ToString();\n\n            var autorizacionResponse = await _autorizacionService.DevolverRefreshToken(request, int.Parse(idUsuario));\n\n\n        if (autorizacionResponse.Resultado)\n            {\n                return Ok(autorizacionResponse);\n            } else\n            {\n                return BadRequest(autorizacionResponse);\n            }\n        }\n\n')),(0,i.yg)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.yg)("div",{parentName:"div",className:"admonition-heading"},(0,i.yg)("h5",{parentName:"div"},(0,i.yg)("span",{parentName:"h5",className:"admonition-icon"},(0,i.yg)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Observaci\xf3n")),(0,i.yg)("div",{parentName:"div",className:"admonition-content"},(0,i.yg)("ul",{parentName:"div"},(0,i.yg)("li",{parentName:"ul"},"El m\xe9todo ReadJwtToken(X) Convierte el string X en una instancia de JwtSecurityToken (es una clase que representa el token)."),(0,i.yg)("li",{parentName:"ul"},"La propiedad Claims , contiene los claims del token en un IEnumerable","<","T>."),(0,i.yg)("li",{parentName:"ul"},"Usamos el m\xe9todo First para obtener el primer elemento que cumpla la condici\xf3n especificada por el primer par\xe1metro (Es un Func","<","Claim , bool> )."),(0,i.yg)("li",{parentName:"ul"},"La propiedad Type de un Claim seria la \u201cclave\u201d que contiene el valor. Es una Uri."),(0,i.yg)("li",{parentName:"ul"},"JwtRegisteredClaimNames  es un struct que contiene todos los tipos de claims registrados."),(0,i.yg)("li",{parentName:"ul"},"Un Claim tiene la propiedad \u201cvalue\u201d la cual contiene el valor.")))))}m.isMDXComponent=!0}}]);